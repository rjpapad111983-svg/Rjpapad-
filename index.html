<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RJ Papad ‚Äî Login / Register / Wallet</title>
  <style>
    :root{--bg:#fff8dc;--accent:#ffb300;--card:#fff;--muted:#666}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Poppins",sans-serif;color:#222}
    header{background:var(--accent);color:#fff;padding:12px 16px;position:relative}
    header h1{margin:0;font-size:18px;text-align:center}
    .menu-btn{position:absolute;left:12px;top:8px;background:transparent;border:none;color:#fff;font-size:24px;cursor:pointer}
    .container{padding:18px;max-width:720px;margin:0 auto}
    .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin:18px 0}
    .full-center{min-height:calc(100vh - 56px);display:flex;align-items:center;justify-content:center;padding:20px}
    input[type="text"], input[type="tel"], input[type="number"]{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin:8px 0}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .sidebar{position:fixed;left:-280px;top:0;width:260px;height:100%;background:#fff;box-shadow:2px 0 14px rgba(0,0,0,0.12);transition:left .28s;padding-top:70px}
    .sidebar.open{left:0}
    .sidebar button{display:block;width:100%;padding:12px 18px;border:none;text-align:left;background:none;cursor:pointer;border-bottom:1px solid #f0f0f0}
    .wallet-balance{font-size:20px;color:#d2691e;font-weight:700}
    ul.requests{list-style:none;padding:0;margin:0}
    .hidden{display:none}
  </style>
</head>
<body>

<header>
  <button id="menuBtn" class="menu-btn" onclick="toggleSidebar()" style="display:none">‚ò∞</button>
  <h1 id="headerTitle">RJ Papad</h1>
</header>

<!-- Sidebar / Menu -->
<div id="sidebar" class="sidebar" aria-hidden="true">
  <button onclick="openView('wallet')">üí∞ Wallet</button>
  <button onclick="openView('team')">üë• My Team</button>
  <button onclick="openAdminPrompt()">üîê Admin (approve)</button>
  <button onclick="logout()">üö™ Logout</button>
  <button onclick="toggleSidebar()">‚ùå Close</button>
</div>

<!-- REGISTER (full screen) -->
<div id="registerScreen" class="full-center">
  <div style="width:100%;max-width:420px">
    <div class="panel">
      <h2 style="margin-top:0">‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç</h2>
      <p class="small">‡§™‡§π‡§≤‡•á ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§Ü‡§™ ‡§≤‡•â‡§Ø‡§≤‡•ç‡§ü‡•Ä ‡§î‡§∞ ‡§µ‡•â‡§≤‡•á‡§ü ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç‡•§</p>
      <input id="reg_name" type="text" placeholder="‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)">
      <input id="reg_mobile" type="tel" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø)">
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" onclick="registerUser()">‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
        <button class="btn" style="background:#999" onclick="showLogin()">Login</button>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN screen -->
<div id="loginScreen" class="full-center hidden">
  <div style="width:100%;max-width:420px">
    <div class="panel">
      <h2 style="margin-top:0">Login</h2>
      <p class="small">‡§Ö‡§™‡§®‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç ‚Äî ‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§®‡•á ‡§™‡§π‡§≤‡•á ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à ‡§§‡•ã ‡§∏‡•Ä‡§ß‡•á login ‡§π‡•ã‡§ó‡§æ‡•§</p>
      <input id="login_mobile" type="tel" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞">
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" onclick="loginUser()">Login</button>
        <button class="btn" style="background:#999" onclick="showRegister()">Register</button>
      </div>
    </div>
  </div>
</div>

<!-- LOGO / HOME (after login) -->
<div id="homeScreen" class="container hidden">
  <div class="panel" id="logoPanel" style="text-align:center;">
    <!-- You can place your logo image here -->
    <img id="topLogo" src="https://raw.githubusercontent.com/rjpapad111983-svg/Rjpapad-/refs/heads/main/file_0000000040986208ae9fdd85a3a3cbc8.png" alt="logo" style="max-width:100%;height:220px;object-fit:contain;border-radius:10px">
    <h2 id="welcomeText">RJ ‡§™‡§æ‡§™‡§°‡§º ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à!</h2>
    <p class="small">Menu ‡§ñ‡•ã‡§≤‡•á‡§Ç ‚Äî Wallet / My Team / Admin</p>
    <div style="margin-top:12px">
      <button class="btn" onclick="goToMain()">Proceed</button>
    </div>
  </div>

  <!-- Wallet Panel -->
  <div id="walletPanel" class="panel hidden">
    <h3>My Wallet</h3>
    <div class="wallet-balance" id="walletBalance">‚Çπ0</div>
    <div class="small" id="bankText">(Bank/UPI not set)</div>
    <div style="margin-top:12px">
      <input id="addAmt" type="number" placeholder="Add amount (‚Çπ)" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:160px">
      <button class="btn" onclick="addMoney()">Add</button>
      <button class="btn" style="background:#777;margin-left:8px" onclick="requestWithdraw()">Withdraw</button>
    </div>
    <div style="margin-top:12px" id="withdrawMsg" class="small"></div>
  </div>

  <!-- My Team -->
  <div id="teamPanel" class="panel hidden">
    <h3>My Team</h3>
    <div id="myTeamContainer" class="small">My Team list will appear here (names only).</div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="panel hidden">
    <h3>Admin Panel ‚Äî Pending Withdraws</h3>
    <div class="small">Only admin can approve/reject</div>
    <ul class="requests" id="requestsList"></ul>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
const ADMIN_PASSWORD = "Rjpapad@2025";
const KEY_USERS = "rp_users_v1";
const KEY_ME = "rp_me";
const KEY_WITHDRAWS = "rp_withdraws_v1";
const KEY_TREE = "rp_tree_v1";
const SHEET_WEBHOOK_URL = ""; // <-- paste your Apps Script URL here if used

/* ========== UTIL ========== */
function loadJSON(k,def){ try{const s=localStorage.getItem(k); return s?JSON.parse(s):def;}catch(e){return def;} }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function nowISO(){ return (new Date()).toISOString(); }

/* ========== SHOW / HIDE SCREENS ========== */
const regScreen = document.getElementById("registerScreen");
const loginScreen = document.getElementById("loginScreen");
const homeScreen = document.getElementById("homeScreen");
const menuBtn = document.getElementById("menuBtn");
const headerTitle = document.getElementById("headerTitle");
function showRegister(){ regScreen.classList.remove("hidden"); loginScreen.classList.add("hidden"); homeScreen.classList.add("hidden"); menuBtn.style.display='none'; headerTitle.textContent='RJ Papad ‚Äî Register'; }
function showLogin(){ regScreen.classList.add("hidden"); loginScreen.classList.remove("hidden"); homeScreen.classList.add("hidden"); menuBtn.style.display='none'; headerTitle.textContent='RJ Papad ‚Äî Login'; }
function showHome(){ regScreen.classList.add("hidden"); loginScreen.classList.add("hidden"); homeScreen.classList.remove("hidden"); menuBtn.style.display='inline-block'; headerTitle.textContent='RJ Papad'; }
function toggleSidebar(){ document.getElementById("sidebar").classList.toggle("open"); }
function openView(name){
  document.getElementById("walletPanel").classList.add("hidden");
  document.getElementById("teamPanel").classList.add("hidden");
  document.getElementById("adminPanel").classList.add("hidden");
  if(name==="wallet") document.getElementById("walletPanel").classList.remove("hidden");
  if(name==="team"){ document.getElementById("teamPanel").classList.remove("hidden"); renderMyTeamList(); }
  if(name==="admin") document.getElementById("adminPanel").classList.remove("hidden");
  document.getElementById("sidebar").classList.remove("open");
}

/* ========== USER STORAGE ========== */
function ensureUsers(){
  let users = loadJSON(KEY_USERS, {});
  if(Object.keys(users).length===0){
    // create demo user(s)
    users["9999999999"] = { mobile:"9999999999", name:"Demo User", balance:1500, bank:{name:"HDFC Bank", upi:"demo@upi"}, created: nowISO() };
    saveJSON(KEY_USERS, users);
  }
}
ensureUsers();

function registerUser(){
  const name = (document.getElementById("reg_name").value || "").trim();
  const mobile = (document.getElementById("reg_mobile").value || "").trim();
  if(!mobile){ alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç"); return; }
  // save user
  const users = loadJSON(KEY_USERS, {});
  if(users[mobile]){ alert("Mobile already registered. Please login."); showLogin(); return; }
  users[mobile] = { mobile, name: name || ("User"+mobile.slice(-4)), balance:0, bank:null, created: nowISO() };
  saveJSON(KEY_USERS, users);
  // mark registered and auto-login
  localStorage.setItem(KEY_ME, mobile);
  alert("‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§∏‡§´‡§≤! ‡§Ü‡§™ ‡§≤‡•â‡§ó ‡§á‡§® ‡§π‡•ã ‡§ó‡§Ø‡•á ‡§π‡•à‡§Ç‡•§");
  showHome(); renderWallet(); renderRequests();
}

function loginUser(){
  const mobile = (document.getElementById("login_mobile").value || "").trim();
  if(!mobile){ alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç"); return; }
  const users = loadJSON(KEY_USERS, {});
  if(!users[mobile]){ 
    if(confirm("‡§Ø‡§π ‡§®‡§Ç‡§¨‡§∞ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")){ document.getElementById("reg_mobile").value = mobile; showRegister(); }
    return;
  }
  // set logged in
  localStorage.setItem(KEY_ME, mobile);
  alert("Login successful");
  showHome(); renderWallet(); renderRequests();
}

/* ========== WALLET ========== */
function getMe(){ return localStorage.getItem(KEY_ME); }
function getUser(mob){ const u = loadJSON(KEY_USERS, {}); return u[mob]||null; }
function saveUser(u){ const users = loadJSON(KEY_USERS, {}); users[u.mobile]=u; saveJSON(KEY_USERS, users); }

function renderWallet(){
  const me = getMe();
  if(!me) return;
  const user = getUser(me);
  if(!user) return;
  document.getElementById("walletBalance").textContent = "‚Çπ" + (user.balance || 0);
  document.getElementById("bankText").textContent = user.bank? `${user.bank.name} ‚Ä¢ ${user.bank.upi || user.bank.account}` : "(Bank/UPI not set)";
}

/* add money (demo) */
function addMoney(){
  const v = Number(document.getElementById("addAmt").value || 0);
  if(!v || v<=0){ alert("‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§°‡§æ‡§≤‡§ø‡§è"); return; }
  const me = getMe();
  const user = getUser(me);
  user.balance = (user.balance||0) + v;
  saveUser(user);
  renderWallet();
  alert("‚Çπ"+v+" added");
}

/* withdraw flow (creates request) */
function loadWithdrawals(){ return loadJSON(KEY_WITHDRAWS, []); }
function saveWithdrawals(arr){ saveJSON(KEY_WITHDRAWS, arr); }
function createWithdrawRequest(mobile, amount){
  const arr = loadWithdrawals();
  const id = "w"+Date.now();
  const fee = Math.round(amount*0.10);
  const after = amount - fee;
  const obj = { id, mobile, amount, fee, after, status:"Pending", created: nowISO(), adminNote:"" };
  arr.unshift(obj);
  saveWithdrawals(arr);
  // deduct now
  const u = getUser(mobile);
  u.balance = (u.balance||0) - amount;
  saveUser(u);
  renderWallet();
  renderRequests();
  maybeLogSheet({action:"withdraw_request", data:obj});
  alert("Withdraw request created (Pending). Admin will approve.");
}

function requestWithdraw(){
  const me = getMe();
  const user = getUser(me);
  const v = Number(prompt("Enter amount to withdraw (‚Çπ):", "100"));
  if(!v || v<=0){ alert("Invalid amount"); return; }
  if(v > (user.balance||0)){ alert("Insufficient balance"); return; }
  if(!user.bank || (!user.bank.upi && !user.bank.account)){ alert("Bank/UPI details missing. Please edit bank first."); return; }
  createWithdrawRequest(me, v);
}

/* render pending requests (admin view) */
function renderRequests(){
  const list = document.getElementById("requestsList");
  const arr = loadWithdrawals();
  list.innerHTML = "";
  if(!arr.length){ list.innerHTML = "<li class='small'>No pending requests</li>"; return; }
  arr.forEach(req=>{
    const li = document.createElement("li");
    li.style.marginBottom = "10px";
    li.innerHTML = `<div><strong>${getUser(req.mobile)?.name || req.mobile}</strong> ‚Ä¢ ‚Çπ${req.amount} <div class="small">After 10%: ‚Çπ${req.after} ‚Ä¢ ${new Date(req.created).toLocaleString()}</div><div class="small">Status: ${req.status}</div></div>`;
    const actions = document.createElement("div");
    actions.style.marginTop = "8px";
    if(req.status==="Pending"){
      const a = document.createElement("button"); a.className="btn"; a.textContent="Approve"; a.onclick = ()=> adminApprove(req.id);
      const r = document.createElement("button"); r.className="btn"; r.style.background="#999"; r.textContent="Reject"; r.onclick = ()=> adminReject(req.id);
      actions.appendChild(a); actions.appendChild(r);
    } else {
      const s = document.createElement("div"); s.className="small"; s.textContent = "Processed";
      actions.appendChild(s);
    }
    li.appendChild(actions);
    list.appendChild(li);
  });
  renderWallet();
}

/* ========== ADMIN ========== */
function openAdminPrompt(){
  const pwd = prompt("Enter admin password:");
  if(!pwd) return;
  if(pwd === ADMIN_PASSWORD){
    toggleSidebar();
    document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("walletPanel").classList.add("hidden");
    document.getElementById("teamPanel").classList.add("hidden");
    renderRequests();
    alert("Admin access granted");
  } else {
    alert("Wrong password");
  }
}

function adminApprove(id){
  if(!confirm("Approve this withdraw request? (Admin must do manual payout)")) return;
  const arr = loadWithdrawals();
  const idx = arr.findIndex(x=>x.id===id);
  if(idx===-1) return alert("Not found");
  const req = arr[idx];
  req.status = "Approved";
  req.adminNote = prompt("Txn ID / Note (optional):","") || "";
  req.processedAt = nowISO();
  saveWithdrawals(arr);
  maybeLogSheet({action:"withdraw_approve", data:req});
  renderRequests();
  alert("Marked Approved. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§¨ ‡§¨‡•à‡§Ç‡§ï/UPI ‡§∏‡•á ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§");
}

function adminReject(id){
  if(!confirm("Reject and refund to user?")) return;
  const arr = loadWithdrawals();
  const idx = arr.findIndex(x=>x.id===id);
  if(idx===-1) return alert("Not found");
  const req = arr[idx];
  // refund
  const u = getUser(req.mobile);
  u.balance = (u.balance||0) + req.amount;
  saveUser(u);
  req.status = "Rejected";
  req.processedAt = nowISO();
  saveWithdrawals(arr);
  maybeLogSheet({action:"withdraw_reject", data:req});
  renderRequests();
  alert("Rejected and refunded.");
}

/* ========== MY TEAM (simple) ========== */
function renderMyTeamList(){
  let nodes = loadJSON(KEY_TREE, null);
  if(!nodes){
    nodes = [
      {id:"root", name:"Rajesh parmar", parent:null, gender:"M"},
      {id:"n1", name:"Maan", parent:"root", gender:"M"},
      {id:"n2", name:"Bhavna", parent:"root", gender:"F"}
    ];
    saveJSON(KEY_TREE, nodes);
  }
  const container = document.getElementById("myTeamContainer");
  let html = "<ul style='list-style:none;padding-left:0;margin:0'>";
  nodes.filter(n=>n.parent==="root").forEach(ch=>{
    html += `<li style="margin:8px 0">${ch.gender==='F'?'üë©':'üë®'} ${ch.name} <button onclick="toggleExpand('${ch.id}')" style="margin-left:8px">[+]</button><div id="children_${ch.id}" style="margin-left:18px"></div></li>`;
  });
  html += "</ul>";
  container.innerHTML = html;
}
function toggleExpand(id){
  const nodes = loadJSON(KEY_TREE, []);
  const children = nodes.filter(n=>n.parent===id);
  const target = document.getElementById("children_"+id);
  if(!target) return;
  if(target.innerHTML.trim()!==""){ target.innerHTML=""; return; }
  let html = "<ul style='list-style:none;padding-left:6px'>";
  children.forEach(c=> html += `<li style="margin:6px 0">${c.gender==='F'?'üë©':'üë®'} ${c.name}</li>`);
  html += "</ul>";
  target.innerHTML = html;
}

/* ========== LOGGING (optional) ========== */
async function maybeLogSheet(payload){
  if(!SHEET_WEBHOOK_URL) return;
  try{
    await fetch(SHEET_WEBHOOK_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
  }catch(e){ console.warn("sheet log failed", e); }
}

/* ========== BOOTSTRAP / ENTRY ========== */
function logout(){
  localStorage.removeItem(KEY_ME);
  document.getElementById("sidebar").classList.remove("open");
  menuBtn.style.display='none';
  showLogin();
}

function goToMain(){
  // after pressing Proceed on logo/homeScreen go to main container
  document.getElementById("logoPanel").classList.add("hidden");
  document.getElementById("walletPanel").classList.remove("hidden");
}

function init(){
  // if user logged in -> show home screen; else if mobile registered -> show login else show register
  const logged = localStorage.getItem(KEY_ME);
  const users = loadJSON(KEY_USERS, {});
  menuBtn.style.display = 'none';
  if(logged && users[logged]){
    // user logged in
    showHome(); renderWallet(); renderRequests();
  } else {
    // if any mobile present in users? show login, else show register
    const allMobiles = Object.keys(users||{});
    if(allMobiles.length>0){
      showLogin();
      document.getElementById("login_mobile").value = allMobiles[0]; // optional prefilling
    } else {
      showRegister();
    }
  }
}
init();
</script>
</body>
</html>
