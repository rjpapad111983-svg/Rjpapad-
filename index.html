<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RJ Papad - Loyalty Wallet</title>
  <style>
    :root{
      --bg:#fff8dc; --accent:#ffb300; --card:#fff; --muted:#666;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Poppins",sans-serif;color:#222}
    header{background:var(--accent);color:#fff;padding:12px 16px;position:relative}
    header h1{margin:0;font-size:18px}
    .menu-btn{position:absolute;left:12px;top:8px;background:transparent;border:none;color:#fff;font-size:24px;cursor:pointer}
    .container{padding:18px;max-width:720px;margin:0 auto}
    .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin:18px 0}
    .sidebar{position:fixed;left:-280px;top:0;width:260px;height:100%;background:#fff;box-shadow:2px 0 14px rgba(0,0,0,0.12);transition:left .28s;padding-top:70px}
    .sidebar.open{left:0}
    .sidebar button{display:block;width:100%;padding:12px 18px;border:none;text-align:left;background:none;cursor:pointer;border-bottom:1px solid #f0f0f0}
    .sidebar button:hover{background:#fffbec}
    .center{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .wallet-balance{font-size:20px;color:#d2691e;font-weight:700}
    ul.requests{list-style:none;padding:0;margin:0}
    ul.requests li{padding:10px;border-radius:8px;margin-bottom:10px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .req-actions button{margin-left:8px}
    .note{font-size:13px;color:#666;margin-top:8px}
    .hidden{display:none}
    .kbd{display:inline-block;padding:6px 8px;background:#f3f3f3;border-radius:6px;font-size:12px;margin-left:6px}
  </style>
</head>
<body>

<header>
  <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
  <h1>RJ Papad ‚Äî Loyalty Wallet</h1>
</header>

<!-- Sidebar / Menu -->
<div id="sidebar" class="sidebar" aria-hidden="true">
  <button onclick="openView('wallet')">üí∞ Wallet</button>
  <button onclick="openView('team')">üë• My Team</button>
  <button onclick="openAdminPrompt()">üîê Admin (approve)</button>
  <button onclick="toggleSidebar()">‚ùå Close</button>
</div>

<!-- Main content -->
<div class="container" id="app">
  <div id="homePanel" class="panel">
    <h2>‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‚Äî RJ Papad Loyalty</h2>
    <p class="small">Menu (‚ò∞) ‡§ñ‡•ã‡§≤‡•á‡§Ç ‚Äî Wallet, My Team ‡§î‡§∞ Admin (approve) ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§ñ‡•ã‡§≤‡•á‡§Ç‡•§</p>
    <div style="margin-top:12px">
      <button class="btn" onclick="openView('wallet')">Open Wallet</button>
      <button class="btn" style="background:#4caf50" onclick="openView('team')">My Team</button>
    </div>
  </div>

  <!-- Wallet -->
  <div id="walletPanel" class="panel hidden">
    <h3>My Wallet</h3>
    <div class="wallet-balance" id="walletBalance">‚Çπ0</div>
    <div class="note" id="walletNote">‡§Ü‡§™‡§ï‡§æ ‡§µ‡•â‡§≤‡•á‡§ü ‡§î‡§∞ withdraw ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§è‡§ó‡§æ‡•§</div>

    <div style="margin-top:12px">
      <input id="addAmt" type="number" placeholder="Add amount (‚Çπ)" style="padding:8px;border-radius:8px;border:1px solid #ddd;width:160px">
      <button class="btn" onclick="addMoney()">Add</button>
      <button class="btn" style="background:#777;margin-left:8px" onclick="requestWithdraw()">Withdraw</button>
    </div>

    <div style="margin-top:12px" id="bankDetailsBox" class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Bank / UPI details</div>
          <div id="bankText" class="small">(Add below)</div>
        </div>
        <div>
          <button onclick="promptEditBank()" class="btn" style="background:#2196f3">Edit</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="small">Withdraw status</div>
      <div id="withdrawMsg" class="note"></div>
    </div>
  </div>

  <!-- My Team -->
  <div id="teamPanel" class="panel hidden">
    <h3>My Team</h3>
    <div id="myTeamContainer" class="note">MLM Tree view will appear here. (Only names shown)</div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="panel hidden">
    <h3>Admin Panel ‚Äî Pending Withdraw Requests</h3>
    <div class="small">Only admin can approve/reject (password protected)</div>
    <ul class="requests" id="requestsList"></ul>
    <div class="note">Approve ‚Üí mark Paid (admin must do manual bank/UPI transfer). Approve stores status. Reject ‚Üí refund balance to user.</div>
  </div>
</div>

<script>
/* ============================
   CONFIG
   ============================ */
// Fixed admin password you asked:
const ADMIN_PASSWORD = "Rjpapad@2025";

// Optional: if you'd like to log actions to a Google Apps Script webhook (sheet),
// set SHEET_WEBHOOK_URL to that script's published Web App URL.
const SHEET_WEBHOOK_URL = ""; // e.g. "https://script.google.com/macros/s/XXXX/exec"

/* ============================
   STORAGE KEYS & HELPERS
   ============================ */
const KEY_USERS = "rp_users_v1";            // store basic users (mobile -> user record)
const KEY_WITHDRAWS = "rp_withdraws_v1";    // withdraw request list
const KEY_ME = "rp_me";                     // current logged-in user mobile (simulate)
const KEY_TREE = "rp_tree_v1";              // mlm tree nodes (simple array)
const nowISO = ()=> (new Date()).toISOString();

function loadJSON(key, def){ try{ const s=localStorage.getItem(key); return s?JSON.parse(s):def; }catch(e){return def;} }
function saveJSON(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }

/* ============================
   Simple Demo User / Login
   (for demo we'll use localStorage user)
   ============================ */
function ensureDemoUser(){
  let users = loadJSON(KEY_USERS, {});
  // if no users exist, create one demo user
  if(Object.keys(users).length === 0){
    users["9999999999"] = { mobile:"9999999999", name:"Demo User", balance:1500, bank:{name:"HDFC Bank", account:"XXXXXX1234", ifsc:"HDFC000000", upi:"demo@upi"}};
    users["8888888888"] = { mobile:"8888888888", name:"Rajesh parmar", balance:2000, bank:{name:"SBI Bank", account:"XXXXXX5678", ifsc:"SBIN00000", upi:"rajesh@upi"}};
    saveJSON(KEY_USERS, users);
  }
  // set "logged in" user for demo - keep KEY_ME set to one of the mobiles
  if(!localStorage.getItem(KEY_ME)) localStorage.setItem(KEY_ME, "9999999999");
}
ensureDemoUser();

/* ============================
   UI Helpers
   ============================ */
function toggleSidebar(){ const s=document.getElementById("sidebar"); s.classList.toggle("open"); }
function openView(name){
  toggleSidebar();
  document.getElementById("homePanel").classList.add("hidden");
  document.getElementById("walletPanel").classList.add("hidden");
  document.getElementById("teamPanel").classList.add("hidden");
  document.getElementById("adminPanel").classList.add("hidden");
  if(name==="wallet") document.getElementById("walletPanel").classList.remove("hidden");
  if(name==="team") { document.getElementById("teamPanel").classList.remove("hidden"); renderMyTeamList(); }
  if(name==="home") document.getElementById("homePanel").classList.remove("hidden");
}

/* ============================
   Wallet logic (balance / add / withdraw)
   ============================ */
function getMeMobile(){ return localStorage.getItem(KEY_ME); }
function getUser(mob){ const users = loadJSON(KEY_USERS, {}); return users[mob]||null; }
function saveUser(user){ const users = loadJSON(KEY_USERS, {}); users[user.mobile] = user; saveJSON(KEY_USERS, users); }

function renderWallet(){
  const mob = getMeMobile();
  const user = getUser(mob);
  if(!user) return;
  document.getElementById("walletBalance").textContent = "‚Çπ" + (user.balance || 0);
  document.getElementById("bankText").textContent = user.bank? `${user.bank.name} ‚Ä¢ ${user.bank.upi || user.bank.account}` : "(Not Set)";
  checkWithdrawStatusForUser();
}
renderWallet();

function addMoney(){
  const v = Number(document.getElementById("addAmt").value || 0);
  if(!v || v<=0){ alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§°‡§æ‡§≤‡•á‡§Ç"); return; }
  const user = getUser(getMeMobile());
  user.balance = (user.balance||0) + v;
  saveUser(user);
  renderWallet();
  alert("‚Çπ"+v+" add ‡§π‡•ã ‡§ó‡§Ø‡§æ");
}

function promptEditBank(){
  const user = getUser(getMeMobile());
  const name = prompt("Bank name", user.bank?.name || "");
  const acct = prompt("Account or UPI", user.bank?.upi || user.bank?.account || "");
  const ifsc = prompt("IFSC (if bank)", user.bank?.ifsc || "");
  if(name===null) return;
  user.bank = { name: name || "", account: acct || "", upi: acct || "", ifsc: ifsc || "" };
  saveUser(user);
  renderWallet();
  alert("Bank/UPI saved");
}

/* ============================
   Withdraw request store + rendering
   ============================ */
function loadWithdrawals(){ return loadJSON(KEY_WITHDRAWS, []); }
function saveWithdrawals(arr){ saveJSON(KEY_WITHDRAWS, arr); }
function createWithdrawRequest(mobile, amount){
  const withdraws = loadWithdrawals();
  const id = "w"+Date.now();
  const fee = Math.round((amount*0.10)); // 10% cut
  const after = amount - fee;
  const obj = { id, mobile, amount, fee, after, status:"Pending", created: nowISO(), adminNote:"" };
  withdraws.unshift(obj);
  saveWithdrawals(withdraws);
  // deduct immediately from balance
  const u = getUser(mobile);
  u.balance = (u.balance || 0) - amount;
  saveUser(u);
  renderWallet();
  renderRequests();
  maybeLogSheet({action:"withdraw_request", data:obj});
  return obj;
}

function renderRequests(){
  const list = document.getElementById("requestsList");
  const arr = loadWithdrawals();
  list.innerHTML = "";
  if(arr.length===0){ list.innerHTML = "<li class='note'>No pending requests</li>"; return; }
  arr.forEach(req=>{
    const li = document.createElement("li");
    const left = document.createElement("div");
    left.innerHTML = `<div><strong>${getUser(req.mobile)?.name || req.mobile}</strong> ‚Ä¢ ‚Çπ${req.amount}</div>
                      <div class="small">After 10%: ‚Çπ${req.after} ‚Ä¢ ${new Date(req.created).toLocaleString()}</div>
                      <div class="small">Status: <span id="status_${req.id}">${req.status}</span></div>`;
    const right = document.createElement("div");
    right.className = "req-actions";
    // Only show approve/reject for Pending
    if(req.status==="Pending"){
      const btnA = document.createElement("button"); btnA.className="btn"; btnA.textContent="Approve"; btnA.onclick = ()=> adminApprove(req.id);
      const btnR = document.createElement("button"); btnR.className="btn"; btnR.style.background="#999"; btnR.textContent="Reject"; btnR.onclick = ()=> adminReject(req.id);
      right.appendChild(btnA); right.appendChild(btnR);
    } else {
      const span = document.createElement("div"); span.className="small"; span.textContent = "Processed";
      right.appendChild(span);
    }
    li.appendChild(left); li.appendChild(right);
    list.appendChild(li);
  });
}

renderRequests();

/* ============================
   Admin functions (prompt -> open panel)
   ============================ */
function openAdminPrompt(){
  const pwd = prompt("Enter admin password:");
  if(!pwd) return;
  if(pwd === ADMIN_PASSWORD){
    // open admin panel
    toggleSidebar();
    document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("walletPanel").classList.add("hidden");
    document.getElementById("teamPanel").classList.add("hidden");
    renderRequests();
    alert("‚úÖ Welcome Admin ‚Äî Access Granted");
  } else {
    alert("‚ùå Wrong password ‚Äî access denied");
  }
}

/* ============================
   Approve / Reject logic
   ============================ */
function adminApprove(id){
  // Admin must do manual bank/UPI transfer in real world.
  if(!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ request ‡§ï‡•ã APPROVE ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? (Admin ‡§ï‡•ã manual transfer ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ)")) return;
  const arr = loadWithdrawals();
  const idx = arr.findIndex(r=>r.id===id);
  if(idx===-1) return alert("Request not found");
  arr[idx].status = "Approved";
  arr[idx].adminNote = prompt("Optional: Enter Txn ID / Note (enter to skip)", "") || "";
  arr[idx].processedAt = nowISO();
  saveWithdrawals(arr);
  renderRequests();
  maybeLogSheet({ action:"withdraw_approve", data: arr[idx] });
  alert("Request marked Approved. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§¨ ‡§¨‡•à‡§Ç‡§ï/UPI ‡§∏‡•á manual ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ Txn ID ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (if not added).");
  renderWallet();
}

function adminReject(id){
  if(!confirm("Reject ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ user ‡§ï‡§æ amount ‡§µ‡§æ‡§™‡§∏ balance ‡§Æ‡•á‡§Ç add ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ ‚Äî Confirm?")) return;
  const arr = loadWithdrawals();
  const idx = arr.findIndex(r=>r.id===id);
  if(idx===-1) return alert("Request not found");
  const req = arr[idx];
  // Refund to user
  const u = getUser(req.mobile);
  u.balance = (u.balance || 0) + req.amount;
  saveUser(u);
  // mark rejected
  req.status = "Rejected";
  req.processedAt = nowISO();
  req.adminNote = prompt("Reason (optional):","Rejected by admin") || req.adminNote || "Rejected";
  saveWithdrawals(arr);
  renderRequests();
  maybeLogSheet({ action:"withdraw_reject", data: req });
  alert("Rejected & refunded to user.");
  renderWallet();
}

/* ============================
   check withdraw status for logged-in user
   ============================ */
function checkWithdrawStatusForUser(){
  const mob = getMeMobile();
  const arr = loadWithdrawals();
  const latest = arr.find(r=>r.mobile === mob);
  const el = document.getElementById("withdrawMsg");
  if(!latest){ el.textContent = ""; return; }
  let txt = `Last withdraw: ‚Çπ${latest.amount} ‚Äî Status: ${latest.status}`;
  if(latest.status === "Approved") txt += ` ‚Ä¢ After Cut: ‚Çπ${latest.after}`;
  if(latest.status === "Rejected") txt += ` ‚Ä¢ Refund processed`;
  el.textContent = txt;
}

/* ============================
   API Hook: optional Google Sheet logging
   ============================ */
async function maybeLogSheet(payload){
  if(!SHEET_WEBHOOK_URL) return;
  try {
    await fetch(SHEET_WEBHOOK_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
  } catch(e){
    console.warn("Sheet webhook failed", e);
  }
}

/* ============================
   Withdraw request UI flow
   ============================ */
function requestWithdraw(){
  const mob = getMeMobile();
  const user = getUser(mob);
  const v = Number(prompt("Enter withdraw amount (‚Çπ):", "100"));
  if(!v || v<=0){ alert("Invalid amount"); return; }
  if(v > (user.balance||0)){ alert("Insufficient balance"); return; }
  // Only allow if bank/upi exist
  if(!user.bank || (!user.bank.upi && !user.bank.account)){
    alert("Bank/UPI details missing. Please set bank/UPI first.");
    return;
  }
  // rule: allow immediate request; admin will approve later
  createWithdrawRequest(mob, v);
  alert("Withdraw request created and balance deducted. Admin will approve.");
}

/* ============================
   Simple My Team (render names only)
   ============================ */
function renderMyTeamList(){
  // For demo we'll show a simple static tree reading from KEY_TREE (or create sample)
  let nodes = loadJSON(KEY_TREE, null);
  if(!nodes){
    nodes = [
      { id:"root", name:"Rajesh parmar", parent:null, gender:"M" },
      { id:"n1", name:"Maan", parent:"root", gender:"M" },
      { id:"n2", name:"Bhavna", parent:"root", gender:"F" }
    ];
    saveJSON(KEY_TREE, nodes);
  }
  const container = document.getElementById("myTeamContainer");
  // render vertical simple list with expandable plus/minus (collapsed by default)
  function buildHtml(parent){
    const children = nodes.filter(n=>n.parent===parent);
    if(children.length===0) return "";
    let html = '<ul style="list-style:none;padding-left:14px">';
    for(const c of children){
      const emoji = c.gender==="F"?"üë©":"üë®";
      html += `<li style="margin:8px 0"><div style="display:flex;align-items:center;gap:8px">
        <span style="font-weight:700">${emoji} ${c.name}</span>
        <button style="margin-left:8px;padding:6px;border-radius:8px" onclick="toggleExpand('${c.id}')">[+]</button>
        </div>
        <div id="children_${c.id}" style="margin-left:18px"></div></li>`;
    }
    html += "</ul>";
    return html;
  }
  container.innerHTML = buildHtml("root");
  // populate sub-children placeholders (they will be empty until + clicked)
}

function toggleExpand(nodeId){
  // when user clicks +, show its children names (one-level) - simple demo
  const nodes = loadJSON(KEY_TREE, []);
  const children = nodes.filter(n=>n.parent===nodeId);
  const target = document.getElementById("children_"+nodeId);
  if(!target) return;
  if(target.innerHTML.trim()!==""){ target.innerHTML=""; return; }
  let html = "<ul style='list-style:none;padding-left:6px'>";
  for(const c of children){
    html += `<li style="margin:6px 0">${c.gender==='F'?'üë©':'üë®'} ${c.name}</li>`;
  }
  html += "</ul>";
  target.innerHTML = html;
}

/* ============================
   init render (on load)
   ============================ */
function init(){
  renderWallet();
  renderRequests();
  // periodically update current user withdraw status
  setInterval(checkWithdrawStatusForUser, 4000);
}
init();

/* ============================
   For easy testing (expose some functions)
   ============================ */
window.openAdminPrompt = openAdminPrompt;
window.openView = openView;
window.renderRequests = renderRequests;
window.addMoney = addMoney;
window.requestWithdraw = requestWithdraw;
window.promptEditBank = promptEditBank;

</script>
</body>
</html>
