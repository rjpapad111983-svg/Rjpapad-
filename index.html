<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RJ Papad тАФ MLM Tree (Vertical) + Wallet</title>
<style>
:root{--bg:#fff8dc;--accent:#ffb300;--card:#fff}
html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif;background:var(--bg);color:#222;height:100%}
button{cursor:pointer}

/* ========== LOCKED CSS START ========== */
.overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:16px;box-sizing:border-box;background:#fff;z-index:60}
.panel{background:var(--card);max-width:520px;width:100%;border-radius:12px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.12)}
h2{margin:0 0 12px;color:#c47d04}
input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
.btn-primary{background:var(--accent);border:0;padding:10px;border-radius:8px;font-weight:700;color:#111}
.btn-secondary{background:#eee;border:0;padding:10px;border-radius:8px;color:#111}
.lang-row{display:flex;gap:8px;justify-content:center;margin-top:8px}
.lang-btn{padding:8px 10px;border-radius:8px;border:1px solid #ccc;cursor:pointer}
.lang-btn.active{background:var(--accent);color:#fff}

/* page banners */
.container{max-width:1024px;margin:0 auto;padding:18px}
.banner{margin:12px auto;max-width:980px}
.banner img{width:100%;height:auto;display:block;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.08)}

/* wallet sidebar */
#walletMenuBtn{display:none;position:fixed;top:12px;right:12px;z-index:999;background:var(--accent);border:none;color:#111;font-size:20px;padding:8px 10px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.12)}
#walletSidebar{position:fixed;top:0;right:-420px;width:420px;height:100%;background:#fff3cd;padding:16px;box-shadow:-8px 0 28px rgba(0,0,0,.16);transition:right .36s ease;z-index:998;overflow:auto}
#walletSidebar.open{right:0}
.walletTop{background:#fff7e6;padding:10px;border-radius:8px;margin-bottom:12px}
.amount{font-size:24px;font-weight:800;color:#0a7a07}
.tree-list{font-size:14px;text-align:left;padding-left:6px}
.node{padding:8px;border-radius:6px;margin:8px 0;background:rgba(0,0,0,0.03)}
.subtree{margin-left:12px;border-left:1px dashed rgba(0,0,0,0.06);padding-left:8px}
.lock-badge{position:fixed;left:12px;top:12px;background:#fff;padding:6px 10px;border-radius:8px;box-shadow:0 3px 10px rgba(0,0,0,.08);font-size:13px;z-index:120}
.info-small{font-size:13px;color:#444;margin-top:8px}

/* txn list */
.txn-filter{display:flex;gap:8px;margin:8px 0}
.txn-item{padding:8px;border-radius:8px;background:#fff;margin:6px 0;border-left:4px solid #ddd}
.txn-type-add{border-left-color:#0a7a07}
.txn-type-transfer{border-left-color:#0073a8}
.balance-small{font-size:12px;color:#333}

/* Tree canvas */
#treeCanvasWrap{position:relative;height:520px;border-radius:10px;background:transparent;overflow:auto;margin:12px 0}
#treeCanvas{position:relative;width:1200px;height:520px}
.tree-node{
  position:absolute;background:#fff;border-radius:8px;padding:8px 12px;min-width:150px;box-shadow:0 10px 20px rgba(0,0,0,.06);
  display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:14px;
}
.node-left{display:flex;align-items:center;gap:10px}
.node-emoji{font-size:20px;margin-right:6px}
.node-name{font-weight:700;color:#7b1f00}
.node-meta{font-size:12px;color:#666}
.node-actions{display:flex;flex-direction:column;gap:6px}
.node-circle{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#e8f8ff;border:2px solid #4fb1e6;color:#0a66a0;cursor:pointer;font-weight:700}
.connector-svg{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

/* responsive small */
@media(max-width:640px){
  #treeCanvas{width:920px}
  .tree-node{min-width:140px;font-size:13px}
  #walletSidebar{width:92%}
}
/* ========== LOCKED CSS END ========== */
</style>
</head>
<body>

<!-- ========== LOCKED UI START ========== -->
<!-- Register Overlay -->
<div id="registerPage" class="overlay">
  <div class="panel">
    <h2>рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░реЗрдВ</h2>
    <input id="regName" placeholder="рдирд╛рдо (рд╡реИрдХрд▓реНрдкрд┐рдХ)" />
    <input id="regMobile" placeholder="рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ (10 рдЕрдВрдХ)" inputmode="numeric" maxlength="10" />
    <select id="regGender" style="margin-top:6px;">
      <option value="unknown">рд▓рд┐рдВрдЧ рдЪреБрдиреЗрдВ (рдЕрдирд┐рд╡рд╛рд░реНрдп рдирд╣реАрдВ)</option>
      <option value="male">Male (рдкреБрд░реБрд╖)</option>
      <option value="female">Female (рдорд╣рд┐рд▓рд╛)</option>
      <option value="other">Other</option>
    </select>
    <button id="btnRegister" class="btn-primary">рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░реЗрдВ</button>
    <p id="regError" style="color:#b00"></p>
    <p class="info-small">рдиреЛрдЯ: рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реЛрддреЗ рд╣реА рдЖрдк MLM tree рдореЗрдВ рдкрд╣рд▓реА рдЦрд╛рд▓реА рдЬрдЧрд╣ рдкрд░ рдЬреБрдбрд╝ рдЬрд╛рдПрдВрдЧреЗ (рдКрдкрд░ тЖТ рдиреАрдЪреЗ)ред</p>
  </div>
</div>

<!-- Login Overlay -->
<div id="loginPage" class="overlay" style="display:none">
  <div class="panel">
    <h2>рд▓реЙрдЧрд┐рди рдХрд░реЗрдВ</h2>
    <input id="loginMobile" placeholder="рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд┐рдпрд╛ рд╣реБрдЖ рдореЛрдмрд╛рдЗрд▓" inputmode="numeric" maxlength="10" />
    <button id="btnLogin" class="btn-primary">рд▓реЙрдЧрд┐рди</button>
    <p id="loginError" style="color:#b00"></p>
  </div>
</div>

<!-- Logo Overlay -->
<div id="logoPage" class="overlay" style="display:none">
  <div class="panel" style="text-align:center;max-width:520px">
    <img id="logoImg" src="" alt="logo" style="max-width:72%;border-radius:10px;box-shadow:0 10px 28px rgba(0,0,0,.08)" />
    <div class="lang-row" style="margin-top:12px">
      <button class="lang-btn active" data-lang="hi">рд╣рд┐рдВрджреА</button>
      <button class="lang-btn" data-lang="en">English</button>
      <button class="lang-btn" data-lang="gu">ркЧрлБркЬрк░рк╛ркдрлА</button>
    </div>
    <div style="height:12px"></div>
    <button id="btnNext" class="btn-primary" style="width:60%">рдЕрдЧрд▓рд╛ рдкреЗрдЬ тЮЬ</button>
  </div>
</div>

<!-- Main Page -->
<div id="mainPage" style="display:none">
  <div class="container">
    <div class="banner"><img id="topBannerImg" src="" alt="top banner" /></div>

    <div id="treeCanvasWrap"><div id="treeCanvas">
      <svg class="connector-svg" id="connectorSvg"></svg>
      <!-- nodes injected by JS -->
    </div></div>

    <div class="banner"><img id="bottomBannerImg" src="" alt="bottom banner" /></div>

    <p id="welcomeText" style="font-weight:700;margin-top:12px">RJ рдкрд╛рдкрдбрд╝ рд▓реЙрдпрд▓реНрдЯреА рдкреНрд░реЛрдЧреНрд░рд╛рдо рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ!</p>
    <div style="margin-top:12px">
      <button id="btnLogout" class="btn-secondary" style="max-width:200px">Logout</button>
    </div>
  </div>
</div>
<!-- ========== LOCKED UI END ========== -->

<!-- Wallet Menu + Sidebar (opens after Logo page only) -->
<button id="walletMenuBtn" aria-label="Open Wallet">тШ░</button>
<div id="walletSidebar" aria-hidden="true">
  <div class="walletTop">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong id="sidebarTitle">ЁЯТ░ Wallet</strong></div>
      <div><button id="closeWallet" class="btn-secondary" style="padding:6px 10px">Close</button></div>
    </div>
    <div style="height:8px"></div>
    <div id="walletInfo"><div id="walletMobile">рдореЛрдмрд╛рдЗрд▓: тАФ</div><div class="amount" id="walletAmount">тВ╣0</div></div>
    <div style="height:8px"></div>
    <div style="display:flex;gap:8px">
      <button id="addMoney" class="btn-primary" style="flex:1">+ тВ╣10</button>
      <button id="openTransfer" class="btn-secondary" style="flex:1">Transfer</button>
    </div>
    <div style="height:8px"></div>
    <button id="viewMyTeam" class="btn-secondary">View My Team</button>
    <div style="height:8px"></div>
    <div style="font-size:13px;color:#444">Tree members: <span id="treeCount">0</span></div>
  </div>

  <hr style="border:none;height:12px" />

  <!-- Transfer Form -->
  <div id="transferBox" style="display:none;margin-bottom:12px">
    <h4 style="margin:6px 0">Transfer Money</h4>
    <input id="transferTo" placeholder="To Mobile (10 digits)" inputmode="numeric" maxlength="10" />
    <input id="transferAmount" placeholder="Amount (тВ╣)" inputmode="numeric" />
    <button id="btnTransfer" class="btn-primary">Send</button>
    <p id="transferMsg" style="color:#b00"></p>
  </div>

  <!-- Transactions -->
  <div>
    <h4 style="margin:8px 0 6px">Transactions</h4>
    <div class="txn-filter">
      <button id="filterAll" class="btn-secondary" style="flex:1">All</button>
      <button id="filterMy" class="btn-secondary" style="flex:1">My</button>
    </div>
    <div id="txnList" style="max-height:220px;overflow:auto"></div>
  </div>

  <hr style="border:none;height:12px" />
  <div>
    <h4 style="margin:8px 0 6px">Full Tree</h4>
    <div id="fullTree" class="tree-list" aria-live="polite"></div>
    <h4 style="margin:10px 0 6px">My Subtree</h4>
    <div id="myTree" class="tree-list"></div>
  </div>

  <div style="height:12px"></div>
  <div style="font-size:12px;color:#333">Note: Tree fills topтЖТdown, leftтЖТright. New joins go to first empty spot (BFS).</div>
</div>

<!-- small locked badge -->
<div class="lock-badge">ЁЯФТ Fixed тАФ only config fields editable</div>

<script>
/* ===========================
 EDITABLE CONFIG (ONLY edit these)
 - Put your webhook URL & secret here (optional)
 - And banner/logo image URLs
 DO NOT edit other code below тАФ it's locked and auto-restore protected.
=========================== */
const SHEET_WEBHOOK_URL = "YOUR_SCRIPT_URL_HERE"; // <-- Apps Script WebApp URL (optional)
const SHEET_SECRET = "rj_secret_2025_xyz";        // <-- secret token (optional)

const LOGO_URL = "https://raw.githubusercontent.com/rjpapad111983-svg/Rjpapad-/refs/heads/main/file_0000000040986208ae9fdd85a3a3cbc8.png";
const TOP_BANNER_URL = "https://raw.githubusercontent.com/rjpapad111983-svg/Rjpapad-/refs/heads/main/file_00000000de7861faafb1b8052e9bd122%20(1).png";
const BOTTOM_BANNER_URL = "https://raw.githubusercontent.com/rjpapad111983-svg/Rjpapad-/refs/heads/main/file_00000000aac061fdacd52dbbf8a83410.png";
/* =========================== */

/* ===== storage keys ===== */
const KEY_MOBILE = "rj_mobile", KEY_NAME = "rj_name", KEY_BALANCES = "rj_balances", KEY_TREE = "rj_tree_nodes", KEY_TXN = "rj_txns";

/* helpers */
const el = id => document.getElementById(id);

/* initial populate images */
document.getElementById('logoImg').src = LOGO_URL;
document.getElementById('topBannerImg').src = TOP_BANNER_URL;
document.getElementById('bottomBannerImg').src = BOTTOM_BANNER_URL;

/* UI elements */
const regP = el('registerPage'), logP = el('loginPage'), logoP = el('logoPage'), mainP = el('mainPage');
const walletBtn = el('walletMenuBtn'), sidebar = el('walletSidebar'), closeWallet = el('closeWallet');
const addMoneyBtn = el('addMoney'), openTransfer = el('openTransfer'), transferBox = el('transferBox');
const transferTo = el('transferTo'), transferAmount = el('transferAmount'), btnTransfer = el('btnTransfer'), transferMsg = el('transferMsg');
const walletAmountEl = el('walletAmount'), walletMobileEl = el('walletMobile');
const treeCountEl = el('treeCount'), fullTreeEl = el('fullTree'), myTreeEl = el('myTree');
const txnList = el('txnList'), filterAll = el('filterAll'), filterMy = el('filterMy'), viewMyTeamBtn = el('viewMyTeam');

const treeCanvas = el('treeCanvas'), connectorSvg = el('connectorSvg');

/* Language buttons */
document.querySelectorAll('.lang-btn').forEach(b=>b.addEventListener('click', ()=>{
  document.querySelectorAll('.lang-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const L = { hi: "RJ рдкрд╛рдкрдбрд╝ рд▓реЙрдпрд▓реНрдЯреА рдкреНрд░реЛрдЧреНрд░рд╛рдо рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ!", en: "Welcome to RJ Papad Loyalty Program!", gu: "RJ рккрк╛рккркб рк▓рлЛркпрк▓рлНркЯрлА рккрлНрк░рлЛркЧрлНрк░рк╛ркоркорк╛ркВ ркЖрккркирлБркВ рк╕рлНрк╡рк╛ркЧркд ркЫрлЗ!" };
  el('welcomeText').textContent = L[b.dataset.lang] || L.hi;
}));

/* ====== Tree functions ======
Nodes stored as array in localStorage under KEY_TREE
node = { index:number, mobile:string, name:string, gender:'male'|'female'|'other'|'unknown', parent:index|null, left:index|null, right:index|null }
Fill rule: BFS (first node with left==null or right==null)
===========================*/
function loadTree(){ try{ const raw = localStorage.getItem(KEY_TREE); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
function saveTree(nodes){ localStorage.setItem(KEY_TREE, JSON.stringify(nodes)); }
function findAvailableParent(nodes){ if(nodes.length===0) return null; for(let i=0;i<nodes.length;i++){ if(nodes[i].left===null || nodes[i].right===null) return nodes[i]; } return null; }
function addNodeToTree(name, mobile, gender){
  const nodes = loadTree(); const newIndex = nodes.length; const newNode = { index:newIndex, mobile, name, gender: gender||'unknown', parent:null, left:null, right:null };
  if(nodes.length===0){ nodes.push(newNode); saveTree(nodes); return { nodes, placedAt:newIndex, parent:null }; } else {
    const parent = findAvailableParent(nodes);
    if(!parent){ newNode.parent = 0; nodes.push(newNode); nodes[0].left = newIndex; saveTree(nodes); return { nodes, placedAt:newIndex, parent:0 }; } else {
      newNode.parent = parent.index; nodes.push(newNode); if(parent.left===null) parent.left = newIndex; else parent.right = newIndex; saveTree(nodes); return { nodes, placedAt:newIndex, parent: parent.index };
    }
  }
}

/* compute levels for drawing (BFS by parent relationships) */
function computeLevels(nodes){
  if(!nodes || nodes.length===0) return [];
  const levels = [];
  // root at index 0
  const queue = [{ idx:0, level:0 }];
  const seen = new Set();
  while(queue.length){
    const cur = queue.shift();
    if(seen.has(cur.idx)) continue;
    seen.add(cur.idx);
    if(!levels[cur.level]) levels[cur.level]=[];
    levels[cur.level].push(cur.idx);
    const node = nodes[cur.idx];
    if(node.left!==null) queue.push({ idx:node.left, level: cur.level+1 });
    if(node.right!==null) queue.push({ idx:node.right, level: cur.level+1 });
  }
  return levels;
}

/* draw tree using absolute positioning + svg lines */
function renderGraphicTree(){
  // clear existing
  treeCanvas.innerHTML = '<svg class="connector-svg" id="connectorSvg"></svg>';
  const svg = el('connectorSvg');
  const nodes = loadTree();
  if(nodes.length===0){
    // set canvas small
    treeCanvas.style.width = '800px'; treeCanvas.style.height = '320px';
    svg.setAttribute('width', treeCanvas.style.width); svg.setAttribute('height', treeCanvas.style.height);
    return;
  }
  const levels = computeLevels(nodes);
  const levelCount = levels.length;
  const width = Math.max(900, levels.reduce((m,l)=>Math.max(m,l.length*220),0));
  const height = Math.max(420, levelCount*140 + 80);
  treeCanvas.style.width = width + 'px'; treeCanvas.style.height = height + 'px';
  svg.setAttribute('width', width); svg.setAttribute('height', height);

  // position map: idx -> {x,y,centerX,centerY}
  const pos = {};
  for(let lvl=0; lvl<levels.length; lvl++){
    const row = levels[lvl];
    const n = row.length;
    for(let i=0;i<n;i++){
      const idx = row[i];
      const segment = width / (n+1);
      const x = segment*(i+1) - 75; // node left
      const y = 40 + lvl*140;
      pos[idx] = { x,y, cx: x + 75, cy: y + 28 }; // center
      // create node element
      const node = nodes[idx];
      const elNode = document.createElement('div');
      elNode.className = 'tree-node';
      elNode.style.left = x + 'px';
      elNode.style.top = y + 'px';
      elNode.id = 'node-' + idx;
      // emoji by gender
      let emoji = 'ЁЯзН';
      if(node.gender === 'male') emoji = 'ЁЯСи';
      else if(node.gender === 'female') emoji = 'ЁЯСй';
      // short name
      const nameShort = node.name || ('User-'+node.index);
      const meta = 'idx:' + node.index + (node.parent===null? '': ' тАв p:'+node.parent);
      elNode.innerHTML = `<div class="node-left"><div class="node-emoji">${emoji}</div><div><div class="node-name">${escapeHtml(nameShort)}</div><div class="node-meta">${node.mobile}</div></div></div>
        <div class="node-actions"><div class="node-circle" title="add/join">+</div><div style="font-size:11px;color:#666;margin-top:4px">${node.left!==null? 'ЁЯСе':''}</div></div>`;
      treeCanvas.appendChild(elNode);
    }
  }

  // draw connectors (parent -> children)
  // clear svg children
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  for(let i=0;i<nodes.length;i++){
    const node = nodes[i];
    if(node.left!==null){
      drawLine(svg, pos[i].cx, pos[i].cy, pos[node.left].cx, pos[node.left].cy);
    }
    if(node.right!==null){
      drawLine(svg, pos[i].cx, pos[i].cy, pos[node.right].cx, pos[node.right].cy);
    }
  }
}

/* draw a smooth path between two points */
function drawLine(svg, x1, y1, x2, y2){
  // create a cubic bezier for a smooth curved line
  const midY = (y1 + y2) / 2;
  const path = document.createElementNS("http://www.w3.org/2000/svg","path");
  const d = `M ${x1} ${y1} C ${x1} ${midY} ${x2} ${midY} ${x2} ${y2}`;
  path.setAttribute('d', d);
  path.setAttribute('stroke', '#cfcfcf');
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke-width','3');
  svg.appendChild(path);
}

/* helpers for HTML escaping */
function escapeHtml(text){ return String(text).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

/* ====== Balances & Transactions (localStorage) ====== */
function loadBalances(){ try{ const raw = localStorage.getItem(KEY_BALANCES); return raw ? JSON.parse(raw) : {}; } catch(e){ return {}; } }
function saveBalances(bals){ localStorage.setItem(KEY_BALANCES, JSON.stringify(bals)); }
function ensureBalance(mobile){ const bals = loadBalances(); if(!(mobile in bals)){ bals[mobile]=0; saveBalances(bals);} return bals; }
function getBalance(mobile){ const bals=loadBalances(); return Number(bals[mobile]||0); }
function setBalance(mobile, amount){ const bals=loadBalances(); bals[mobile]=Number(amount); saveBalances(bals); }

function loadTxns(){ try{ const raw = localStorage.getItem(KEY_TXN); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
function saveTxns(txns){ localStorage.setItem(KEY_TXN, JSON.stringify(txns)); }

function addTxn(type, from, to, amount, note){
  const txns = loadTxns(); const t = { id: Date.now(), type, from: from||null, to: to||null, amount: Number(amount), note: note||'', time: (new Date()).toISOString() };
  txns.unshift(t); saveTxns(txns); saveToSheet(type, from||to, '', amount, to, undefined); renderTxns(currentFilter);
}

/* render transactions */
let currentFilter = 'all';
function renderTxns(filter){
  currentFilter = filter || currentFilter; txnList.innerHTML=''; const txns = loadTxns(); const myMobile = localStorage.getItem(KEY_MOBILE);
  const list = txns.filter(t => currentFilter==='all' ? true : (t.from===myMobile || t.to===myMobile));
  if(list.length===0){ txnList.innerHTML = '<div style="color:#666">No transactions</div>'; return; }
  list.forEach(t=>{ const div = document.createElement('div'); div.className='txn-item ' + (t.type==='add' ? 'txn-type-add' : 'txn-type-transfer'); const time = new Date(t.time).toLocaleString();
    if(t.type==='add' || t.type==='register'){ div.innerHTML = `<div><strong>${t.type==='register'?'Registered':'Added тВ╣'+t.amount}</strong></div><div class="balance-small">to: ${t.to||'тАФ'} тАв ${time}</div><div style="font-size:13px;color:#444">${t.note||''}</div>`; }
    else { div.innerHTML = `<div><strong>Transfer тВ╣${t.amount}</strong></div><div class="balance-small">from: ${t.from} тЖТ to: ${t.to} тАв ${time}</div><div style="font-size:13px;color:#444">${t.note||''}</div>`; }
    txnList.appendChild(div);
  });
}

/* ====== UI and Wallet flow ====== */
function updateWalletUI(){ const mob = localStorage.getItem(KEY_MOBILE) || 'тАФ'; ensureBalance(mob); const amt = getBalance(mob); walletMobileEl.textContent = 'рдореЛрдмрд╛рдЗрд▓: ' + mob; walletAmountEl.textContent = 'тВ╣' + amt; }
walletBtn.addEventListener('click', ()=>{ sidebar.classList.toggle('open'); sidebar.setAttribute('aria-hidden', sidebar.classList.contains('open') ? 'false' : 'true'); renderFullTreeList(); renderMySubtreeList(); renderTxns(currentFilter); });
closeWallet.addEventListener('click', ()=>{ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); });

addMoneyBtn.addEventListener('click', ()=>{ const mobile = localStorage.getItem(KEY_MOBILE); if(!mobile){ alert('Login required'); return;} ensureBalance(mobile); const bal = getBalance(mobile); setBalance(mobile, bal+10); updateWalletUI(); addTxn('add', null, mobile, 10, 'Manual add +10'); alert('тВ╣10 added'); });

openTransfer.addEventListener('click', ()=>{ transferBox.style.display = transferBox.style.display==='none' ? 'block' : 'none'; transferMsg.textContent=''; });
btnTransfer.addEventListener('click', ()=>{ transferMsg.textContent=''; const from = localStorage.getItem(KEY_MOBILE); if(!from){ transferMsg.textContent='Login required'; return; } const to = transferTo.value.trim(); const amtRaw = transferAmount.value.trim(); if(!/^[0-9]{10}$/.test(to)){ transferMsg.textContent='рдХреГрдкрдпрд╛ рд╕рд╣реА To рдореЛрдмрд╛рдЗрд▓ рдбрд╛рд▓реЗрдВ'; return; } if(!amtRaw||isNaN(amtRaw)||Number(amtRaw)<=0){ transferMsg.textContent='рд╕рд╣реА рд░рд╛рд╢рд┐ рдбрд╛рд▓реЗрдВ'; return;} const amt=Math.floor(Number(amtRaw)); const bal=getBalance(from); if(amt>bal){ transferMsg.textContent='Insufficient balance'; return; } const nodes = loadTree(); const exists = nodes.find(n => n && n.mobile===to); if(!exists){ transferMsg.textContent='Recipient not registered'; return; } setBalance(from, bal-amt); ensureBalance(to); setBalance(to, getBalance(to)+amt); addTxn('transfer', from, to, amt, 'User transfer'); updateWalletUI(); transferMsg.style.color='green'; transferMsg.textContent='Transfer successful'; transferTo.value=''; transferAmount.value=''; });

viewMyTeamBtn.addEventListener('click', ()=>{ renderMySubtreeList(); sidebar.classList.add('open'); });

filterAll.addEventListener('click', ()=>{ renderTxns('all'); });
filterMy.addEventListener('click', ()=>{ renderTxns('my'); });

/* Register & Login flows */
el('btnRegister').addEventListener('click', async ()=>{
  const name = el('regName').value.trim(), mobile = el('regMobile').value.trim(), gender = el('regGender').value || 'unknown';
  el('regError').textContent = '';
  if(!/^[0-9]{10}$/.test(mobile)){ el('regError').textContent='рдХреГрдкрдпрд╛ 10 рдЕрдВрдХреЛрдВ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рдбрд╛рд▓реЗрдВ'; return; }
  localStorage.setItem(KEY_MOBILE, mobile); localStorage.setItem(KEY_NAME, name||'');
  ensureBalance(mobile); setBalance(mobile, 0);
  const res = addNodeToTree(name, mobile, gender);
  alert('рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реБрдЖ тАФ tree index: ' + res.placedAt + (res.parent!==null ? (' (parent: '+res.parent+')') : ' (root)'));
  addTxn('register', null, mobile, 0, 'Registered'); await saveToSheet('register', mobile, name, res.placedAt);
  regP.style.display='none'; logP.style.display='flex';
});

el('btnLogin').addEventListener('click', ()=>{ const mobile = el('loginMobile').value.trim(); el('loginError').textContent=''; if(!/^[0-9]{10}$/.test(mobile)){ el('loginError').textContent='рдХреГрдкрдпрд╛ 10 рдЕрдВрдХреЛрдВ рдХрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рдбрд╛рд▓реЗрдВ'; return; } const saved = localStorage.getItem(KEY_MOBILE); if(!saved || mobile !== saved){ el('loginError').textContent='рдпрд╣ рдореЛрдмрд╛рдЗрд▓ рд░рдЬрд┐рд╕реНрдЯрд░ рдирд╣реАрдВ рд╣реИ'; return; } logP.style.display='none'; logoP.style.display='flex'; });

el('btnNext').addEventListener('click', ()=>{ logoP.style.display='none'; mainP.style.display='block'; walletBtn.style.display='block'; updateWalletUI(); renderGraphicTree(); renderFullTreeList(); renderMySubtreeList(); renderTxns('my'); });

el('btnLogout').addEventListener('click', ()=>{ mainP.style.display='none'; logP.style.display='flex'; walletBtn.style.display='none'; });

/* Full Tree & My Subtree (list form inside sidebar) */
function renderFullTreeList(){
  const nodes = loadTree();
  fullTreeEl.innerHTML = '';
  if(nodes.length===0){ fullTreeEl.textContent='Tree empty'; treeCountEl.textContent='0'; return; }
  treeCountEl.textContent = String(nodes.length);
  nodes.forEach(n => {
    const d = document.createElement('div'); d.className='node'; d.textContent = `${n.index}: ${n.name || '(No name)'} тАФ ${n.mobile}`;
    fullTreeEl.appendChild(d);
  });
}
function renderMySubtreeList(){
  myTreeEl.innerHTML = '';
  const my = localStorage.getItem(KEY_MOBILE);
  if(!my){ myTreeEl.textContent='Login to view your team'; return; }
  const nodes = loadTree();
  const me = nodes.find(n => n && n.mobile===my);
  if(!me){ myTreeEl.textContent='рдЖрдкрдХрд╛ рд░рд┐рдХреЙрд░реНрдб tree рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓рд╛'; return; }
  // reuse renderSubtree for list-ish
  const pack = document.createElement('div');
  function rec(idx, container){
    const node = nodes[idx]; const elDiv = document.createElement('div'); elDiv.className='node'; elDiv.textContent = `${node.index}: ${node.name || '(No name)'} тАФ ${node.mobile}`; container.appendChild(elDiv);
    if(node.left!==null || node.right!==null){
      const c = document.createElement('div'); c.className='subtree';
      if(node.left!==null) rec(node.left, c); if(node.right!==null) rec(node.right, c);
      container.appendChild(c);
    }
  }
  rec(me.index, pack); myTreeEl.appendChild(pack);
}

/* ========== Sheet Save helper ========== */
async function saveToSheet(action, mobile, name, amount, toMobile, toAmount){
  if(!SHEET_WEBHOOK_URL || !SHEET_WEBHOOK_URL.startsWith('http')){ console.log('Webhook not configured'); return; }
  const payload = { secret: SHEET_SECRET, action, user_mobile: mobile, user_name: name, language: (document.querySelector('.lang-btn.active')?.dataset?.lang || 'hi') };
  if(typeof amount !== 'undefined') payload.amount = amount;
  if(typeof toMobile !== 'undefined') payload.toMobile = toMobile;
  if(typeof toAmount !== 'undefined') payload.toAmount = toAmount;
  try{
    const res = await fetch(SHEET_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    console.log('sheet response', await res.text());
  }catch(e){ console.warn('sheet failed', e); }
}

/* ========== Auto-Lock & Init ========== */
window.addEventListener('DOMContentLoaded', ()=>{
  // integrity check (locked markers)
  const html = document.documentElement.innerHTML;
  if(!html.includes('LOCKED UI START') || !html.includes('LOCKED UI END')){
    alert('тЪая╕П Locked code modified. Reloading to recover original.');
    location.reload();
  }
  // initial UI state
  regP.style.display='flex'; logP.style.display='none'; logoP.style.display='none'; mainP.style.display='none';
  walletBtn.style.display='none';
  // init storage
  if(!localStorage.getItem(KEY_TREE)) localStorage.setItem(KEY_TREE, JSON.stringify([]));
  if(!localStorage.getItem(KEY_TXN)) localStorage.setItem(KEY_TXN, JSON.stringify([]));
  if(!localStorage.getItem(KEY_BALANCES)) localStorage.setItem(KEY_BALANCES, JSON.stringify({}));
  renderGraphicTree(); renderFullTreeList(); updateWalletUI(); renderTxns('my');
});
/* ========== END ========== */
</script>
</body>
</html>
