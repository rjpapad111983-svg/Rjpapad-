<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RJ Papad — Register/Login (Locked after first register)</title>
<style>
:root{--accent:#ffb300;--bg:#fff8dc;--card:#fff;--muted:#666}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Roboto,Arial;background:var(--bg);color:#222}
header{background:var(--accent);color:#fff;padding:10px 14px;display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:30}
.menu-btn{font-size:22px;cursor:pointer}
.brand{flex:1;text-align:center;font-weight:700}
.container{max-width:980px;margin:14px auto;padding:0 14px}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.06);margin-bottom:14px}
input,button,select,textarea{font-size:15px;padding:10px;border-radius:8px;border:1px solid #ddd}
button.primary{background:var(--accent);border:none;color:#fff}
button.ghost{background:#f5f5f5;border:none}
.small{color:var(--muted);font-size:13px}
.hidden{display:none}
.logo-top img{max-width:160px;border-radius:8px}
@media(min-width:900px){.logo-top img{max-width:220px}}
</style>
</head>
<body>

<header>
  <div class="menu-btn" id="menuToggle">☰</div>
  <div class="brand">RJ Papad</div>
  <div style="display:flex;gap:8px;align-items:center">
    <div id="adminStatus" class="small">User</div>
    <button id="adminLoginBtn" class="ghost">Admin Login</button>
    <button id="adminLogoutBtn" class="ghost hidden">Logout</button>
  </div>
</header>

<div class="container">

  <!-- AUTH area -->
  <div id="authCard" class="card">
    <div class="logo-top" style="text-align:center">
      <img src="https://raw.githubusercontent.com/rjpapad111983-svg/Rjpapad-/refs/heads/main/file_0000000040986208ae9fdd85a3a3cbc8.png" alt="Logo">
    </div>

    <h2 id="authTitle">Register / Login</h2>

    <!-- Register -->
    <div id="fullRegisterBlock" class="hidden">
      <label>नाम (optional)</label>
      <input id="reg_name" placeholder="Name (optional)" />
      <div style="height:8px"></div>

      <label>मोबाइल नंबर (required)</label>
      <input id="reg_mobile" placeholder="Mobile number" />
      <div style="height:8px"></div>

      <label>Parent / Joined by (optional)</label>
      <input id="reg_parent" placeholder="Parent mobile (optional)" />
      <div style="height:10px"></div>

      <div style="display:flex;gap:8px">
        <button id="registerBtn" class="primary" style="flex:1">Register</button>
        <button id="registerCancelBtn" class="ghost" style="flex:1">Cancel</button>
      </div>
    </div>

    <!-- Login -->
    <div id="loginOnlyBlock" class="hidden">
      <label>मोबाइल नंबर (Login)</label>
      <input id="login_mobile" placeholder="Enter mobile to login" />
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button id="loginOnlyBtn" class="primary" style="flex:1">Login</button>
        <button id="showRegisterForJoinBtn" class="ghost" style="flex:1">Register with Parent</button>
      </div>
    </div>

    <div id="authMsg" class="small" style="margin-top:8px;color:#b00"></div>
    <div id="authInfo" class="small" style="margin-top:8px;color:#333">
      पहली बार साइट पर पहले user को Register करना होगा। एक बार कोई user register हो गया तो भविष्य में Register फॉर्म नहीं दिखेगा — केवल Login दिखेगा। (यदि आवश्यकता हो तो Admin उसे Unlock कर सकता है)।
    </div>
  </div>

  <!-- Wallet (simple) -->
  <div id="walletArea" class="card hidden">
    <h3>My Wallet</h3>
    <div style="font-size:22px;font-weight:bold">₹<span id="bal">0</span></div>
    <div style="height:8px"></div>
    <input id="addAmt" placeholder="Amount ₹"><button id="addBtn" class="primary">Add</button>
    <hr style="margin:12px 0">
    <h4>Transfer</h4>
    <input id="t_mobile" placeholder="Recipient mobile"><br><br>
    <input id="t_amount" placeholder="Amount ₹"><br><br>
    <button id="transferBtn" class="primary">Transfer</button>
    <div id="transferMsg" class="small" style="margin-top:8px"></div>
    <hr style="margin:12px 0">
    <button id="withdrawBtn" class="ghost">Withdraw (Request)</button>
    <div id="walletMsg" class="small" style="margin-top:8px;color:#b00"></div>
  </div>

  <!-- Team -->
  <div id="teamArea" class="card hidden">
    <h3>My Team</h3>
    <div id="teamList"></div>
  </div>

  <!-- Tree -->
  <div id="treeArea" class="card hidden">
    <h3>MLM Tree</h3>
    <div id="treeView"></div>
  </div>

  <!-- Admin Panel (unlock/register) -->
  <div id="adminPanel" class="card hidden">
    <h3>Admin Panel</h3>
    <div style="margin-top:8px">
      <div>Register Form Locked (after first register): <b id="regLockedLabel">—</b></div>
      <div style="height:8px"></div>
      <button id="unlockRegisterBtn" class="primary">Unlock Registration (show Register form again)</button>
    </div>
    <div style="height:12px"></div>
    <div>
      <button id="closeAdminBtn" class="ghost">Close Admin Panel</button>
    </div>
  </div>

</div>

<script>
/* ========= CONFIG ========= */
const ADMIN_PWD = "Rjpapad@2025";

/* ========= STORAGE KEYS ========= */
const KEY_USERS = 'rp_users_v6';
const KEY_ME = 'rp_me_v6';
const KEY_WDS = 'rp_withdraws_v6';
const KEY_REG_LOCK = 'rp_register_disabled_v1'; // flag to disable register form after first register

function load(key, def){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; }
}
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ========= APP STATE ========= */
let users = load(KEY_USERS, {}) || {};
let me = load(KEY_ME, null);
let withdraws = load(KEY_WDS, []) || [];
let regLocked = load(KEY_REG_LOCK, false); // when true, register form hidden permanently (until admin unlock)

/* autosave */
function persistAll(){ save(KEY_USERS, users); save(KEY_ME, me); save(KEY_WDS, withdraws); save(KEY_REG_LOCK, regLocked); }
setInterval(persistAll, 2000);
window.addEventListener('beforeunload', persistAll);

/* ========= UI Refs ========= */
const fullRegister = document.getElementById('fullRegisterBlock');
const loginOnly = document.getElementById('loginOnlyBlock');
const authCard = document.getElementById('authCard');
const authMsg = document.getElementById('authMsg');

const regName = document.getElementById('reg_name'), regMobile = document.getElementById('reg_mobile'), regParent = document.getElementById('reg_parent');
const registerBtn = document.getElementById('registerBtn'), registerCancelBtn = document.getElementById('registerCancelBtn');
const loginOnlyBtn = document.getElementById('loginOnlyBtn'), loginMobile = document.getElementById('login_mobile'), showRegisterForJoinBtn = document.getElementById('showRegisterForJoinBtn');

const adminLoginBtn = document.getElementById('adminLoginBtn'), adminLogoutBtn = document.getElementById('adminLogoutBtn'), adminStatus = document.getElementById('adminStatus');
const adminPanel = document.getElementById('adminPanel'), unlockRegisterBtn = document.getElementById('unlockRegisterBtn'), regLockedLabel = document.getElementById('regLockedLabel'), closeAdminBtn = document.getElementById('closeAdminBtn');

const walletArea = document.getElementById('walletArea'), balSpan = document.getElementById('bal'), addAmt = document.getElementById('addAmt'), addBtn = document.getElementById('addBtn');
const transferBtn = document.getElementById('transferBtn'), transferMsg = document.getElementById('transferMsg'), t_mobile = document.getElementById('t_mobile'), t_amount = document.getElementById('t_amount');
const withdrawBtn = document.getElementById('withdrawBtn'), walletMsg = document.getElementById('walletMsg');

const teamArea = document.getElementById('teamArea'), teamList = document.getElementById('teamList');
const treeArea = document.getElementById('treeArea'), treeView = document.getElementById('treeView');

/* admin state */
let isAdmin = false;

/* ========= UI Logic ========= */

/* Show register vs login depending on users and regLocked */
function showAuthBasedOnUsers(){
  authMsg.innerText = '';
  // if no users -> must show register (unless regLocked true which would lock out, so ensure false)
  if(Object.keys(users).length === 0){
    fullRegister.classList.remove('hidden');
    loginOnly.classList.add('hidden');
    return;
  }
  // if registration locked OR at least one user exists -> show login only
  fullRegister.classList.add('hidden');
  loginOnly.classList.remove('hidden');
}

/* Register handler: create user, set regLocked flag true (auto-lock), login as that user */
registerBtn.onclick = ()=>{
  const n = regName.value.trim(), m = regMobile.value.trim(), p = regParent.value.trim();
  if(!m){ authMsg.innerText = 'मोबाइल नंबर आवश्यक है'; return; }
  if(users[m]){ authMsg.innerText = 'User already exists — please login'; return; }
  // create user (no bank fields here)
  users[m] = { mobile: m, name: n || m, balance: 0, parent: null, children: [], bank: null };
  if(p && users[p]){ users[m].parent = p; users[p].children = users[p].children || []; users[p].children.push(m); }
  me = { mobile: m, name: users[m].name };
  // IMPORTANT: auto-lock registration after first successful register
  regLocked = true;
  persistAll();
  enterApp();
};

/* cancel register */
registerCancelBtn.onclick = ()=>{ regName.value=''; regMobile.value=''; regParent.value=''; showAuthBasedOnUsers(); };

/* Login handler */
loginOnlyBtn.onclick = ()=>{
  const m = loginMobile.value.trim();
  if(!m){ authMsg.innerText = 'मोबाइल डालें'; return; }
  if(users[m]){ me = { mobile: m, name: users[m].name }; persistAll(); enterApp(); } else authMsg.innerText = 'User नहीं मिला — Register with Parent देखें';
};
showRegisterForJoinBtn.onclick = ()=>{
  // show register form for parent-join only if registration is not locked and user exists
  if(regLocked){
    alert('Registration temporarily disabled (locked). Admin से संपर्क करें।');
    return;
  }
  fullRegister.classList.remove('hidden'); loginOnly.classList.add('hidden'); authCard.scrollIntoView();
};

/* Enter app after login/register */
function enterApp(){
  authCard.classList.add('hidden');
  updateLoggedAs();
  openSection('wallet');
  updateWallet();
  renderTeam(); renderTree();
}

/* Open sections simple */
function hideAll(){ document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden')); authCard.classList.add('hidden'); adminPanel.classList.add('hidden'); }
function openSection(name){
  hideAll();
  if(name==='wallet') walletArea.classList.remove('hidden');
  if(name==='team') teamArea.classList.remove('hidden');
  if(name==='tree') treeArea.classList.remove('hidden');
  if(name==='admin') adminPanel.classList.remove('hidden');
}

/* Admin login/logout */
adminLoginBtn.onclick = ()=>{
  const p = prompt('Enter admin password:');
  if(!p) return;
  if(p === ADMIN_PWD){
    isAdmin = true;
    adminStatus.innerText = 'Admin';
    adminLoginBtn.classList.add('hidden');
    adminLogoutBtn.classList.remove('hidden');
    adminPanel.classList.remove('hidden');
    updateAdminPanel();
    openSection('admin');
    alert('Admin login successful');
  } else alert('Wrong password');
};
adminLogoutBtn.onclick = ()=>{
  isAdmin = false;
  adminStatus.innerText = 'User';
  adminLoginBtn.classList.remove('hidden');
  adminLogoutBtn.classList.add('hidden');
  adminPanel.classList.add('hidden');
  showAuthBasedOnUsers();
};

/* Admin: Unlock registration */
unlockRegisterBtn.onclick = ()=>{
  if(!isAdmin) return alert('Admin login required');
  if(!confirm('Unlock registration so Register form shows again on site?')) return;
  regLocked = false;
  persistAll();
  updateAdminPanel();
  alert('Registration unlocked. Now Register form will show when appropriate.');
};

closeAdminBtn.onclick = ()=>{ adminPanel.classList.add('hidden'); openSection('home'); };

/* Admin panel update */
function updateAdminPanel(){
  regLockedLabel.innerText = regLocked ? 'YES (disabled for users)' : 'NO (users can register)';
}

/* Wallet / Transfer / Withdraw simple functions */
function updateWallet(){ if(!me) return; balSpan.innerText = ((users[me.mobile].balance||0).toFixed(2)); updateLoggedAs(); }
addBtn.onclick = ()=>{ if(!me) return alert('Login first'); const v=parseFloat(addAmt.value||0); if(!v||v<=0) return alert('Invalid amount'); users[me.mobile].balance = Math.round(((users[me.mobile].balance||0)+v)*100)/100; addAmt.value=''; persistAll(); updateWallet(); };

transferBtn.onclick = ()=>{
  if(!me) return alert('Login first');
  const to = t_mobile.value.trim(), amt = parseFloat(t_amount.value||0);
  transferMsg.innerText=''; transferMsg.style.color='';
  if(!to) return transferMsg.innerText='Recipient mobile चाहिए';
  if(!amt||amt<=0) return transferMsg.innerText='Valid amount डालें';
  if(!users[to]) return transferMsg.innerText='Recipient user not found';
  if((users[me.mobile].balance||0) < amt) return transferMsg.innerText='आपके पास पर्याप्त बैलेंस नहीं';
  users[me.mobile].balance = Math.round(((users[me.mobile].balance||0)-amt)*100)/100;
  users[to].balance = Math.round(((users[to].balance||0)+amt)*100)/100;
  persistAll(); updateWallet();
  transferMsg.style.color='green'; transferMsg.innerText = `₹${amt} भेज दिए गए ${to}`; setTimeout(()=>{ transferMsg.innerText=''; },1500);
};

function canRequestWithdraw(){ const now=new Date(); return (now.getDate()===1 && now.getHours()>=20); }
withdrawBtn.onclick = ()=>{
  if(!me) return alert('Login first');
  const u = users[me.mobile];
  if(!u || (u.balance||0)<=0) return alert('No balance');
  if(!u.bank || !u.bank.name || !u.bank.account || !u.bank.ifsc) return alert('Bank details missing (add via Admin or Wallet section).');
  if(!canRequestWithdraw()){ walletMsg.style.color='#b00'; walletMsg.innerText='Withdraw only 1st day after 20:00'; return; }
  const want = parseFloat(prompt('Enter withdraw amount (₹)')); if(!want||want<=0) return; if(want>u.balance) return alert('Not enough');
  const fee = Math.round(want*0.10);
  u.balance = Math.round((u.balance-want)*100)/100;
  withdraws.push({id:Date.now(), mobile:me.mobile, amount:want, fee, status:'pending'});
  persistAll(); updateWallet(); walletMsg.style.color='green'; walletMsg.innerText='Withdraw request submitted';
};

/* Team & Tree */
function renderTeam(){ teamList.innerHTML=''; if(!me) return; const kids = users[me.mobile].children||[]; if(!kids.length){ teamList.innerHTML='<div class="small">No team members yet</div>'; return; } kids.forEach(m=>{ const d=document.createElement('div'); d.className='card'; d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center'; d.style.marginBottom='6px'; d.innerHTML = `<div>${users[m].name||m}<div class="small">${m}</div></div><div><button class="ghost">[+]</button></div>`; teamList.appendChild(d); d.querySelector('button').onclick = ()=> alert('Downline: ' + ((users[m].children||[]).map(x=>users[x].name||x).join(', ') || 'None')); }); }
function renderTree(){ treeView.innerHTML=''; if(!me) return; const root = users[me.mobile]; const box=document.createElement('div'); box.className='card'; box.innerHTML=`<b>${root.name}</b><div class="small">${root.mobile}</div>`; treeView.appendChild(box); const kids = root.children||[]; if(!kids.length){ const e=document.createElement('div'); e.className='card'; e.style.textAlign='center'; e.innerHTML='No downline<br/><button id="joinHere" class="primary">Join here</button>'; treeView.appendChild(e); e.querySelector('#joinHere').onclick=()=>{ fullRegister.classList.remove('hidden'); loginOnly.classList.add('hidden'); regParent.value = me.mobile; authCard.classList.remove('hidden'); }; return; } const row=document.createElement('div'); row.style.display='flex'; row.style.gap='12px'; row.style.marginTop='12px'; kids.forEach(k=>{ const c=document.createElement('div'); c.className='card'; c.style.minWidth='140px'; c.style.textAlign='center'; c.innerText=users[k].name||k; row.appendChild(c); }); treeView.appendChild(row); }

/* Helpers */
function updateLoggedAs(){ document.querySelector('#adminStatus').innerText = isAdmin ? 'Admin' : 'User'; }
function initUI(){
  // show register or login based on users and regLocked
  // if there are no users, force show register even if regLocked=false (useful first time)
  if(Object.keys(users).length === 0){
    regLocked = false; // ensure first-time registration allowed
    persistAll();
  }
  showAuthBasedOnUsers();
  updateAdminPanel();
}
initUI();
</script>

</body>
</html>
