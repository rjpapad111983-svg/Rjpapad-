
<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RJ Papad ‚Äî Fixed / Editable Sections</title>
<style>
:root{--accent:#ffb300;--bg:#fff8dc;--card:#fff;--muted:#666}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Roboto,Arial;background:var(--bg);color:#222}
header{background:var(--accent);color:#fff;padding:10px 14px;display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:30}
.menu-btn{font-size:22px;cursor:pointer}
.brand{flex:1;text-align:center;font-weight:700}
.container{max-width:980px;margin:14px auto;padding:0 14px}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.06);margin-bottom:14px}
input,button,select,textarea{font-size:15px;padding:10px;border-radius:8px;border:1px solid #ddd}
button.primary{background:var(--accent);border:none;color:#fff}
button.ghost{background:#f5f5f5;border:none}
.small{color:var(--muted);font-size:13px}
.hidden{display:none}
.banner img{width:100%;border-radius:12px;display:block}
.drawer{position:fixed;left:0;top:0;bottom:0;width:320px;background:#fff;box-shadow:2px 0 18px rgba(0,0,0,0.12);transform:translateX(-120%);transition:transform .25s;z-index:40;padding:18px}
.drawer.open{transform:translateX(0)}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,0.25);display:none;z-index:35}
.edit-tools{display:flex;gap:8px;align-items:center}
.edit-btn{cursor:pointer;padding:6px;border-radius:6px;background:#fff;border:1px solid #ddd}
.locked-badge{background:#f1f1f1;border-radius:6px;padding:4px 8px;font-size:12px;color:#666;margin-left:8px}
.editable-highlight{outline:2px dashed rgba(255,179,0,0.8);padding:6px;border-radius:6px}
.logo-top img{max-width:160px;border-radius:8px}
.note{font-size:13px;color:#555}
@media(min-width:900px){.logo-top img{max-width:220px}}
</style>
</head>
<body>

<header>
  <div class="menu-btn" id="menuToggle">‚ò∞</div>
  <div class="brand">RJ Papad ‚Äî Admin Edit & Lock Demo</div>
  <div id="adminAreaHeader" style="display:flex;gap:8px;align-items:center">
    <div id="adminStatus" class="small">User</div>
    <button id="adminLoginBtn" class="ghost">Admin Login</button>
    <button id="adminLogoutBtn" class="ghost hidden">Logout</button>
    <button id="toggleEditMode" class="ghost hidden">Enter Edit Mode</button>
  </div>
</header>

<div id="drawer" class="drawer" aria-hidden="true">
  <h3>Menu</h3>
  <div id="loggedAs" class="small" style="margin-bottom:10px">Not logged</div>
  <button id="btnWallet">üí∞ Wallet</button>
  <button id="btnMyTeam">üë• My Team</button>
  <button id="btnTree">üå≥ MLM Tree</button>
  <button id="btnOrder">üõí Place Order</button>
  <hr style="margin:12px 0" />
  <button id="btnAdminPanel" class="ghost">üîê Admin Panel</button>
  <div style="height:8px"></div>
  <button id="btnLogout" class="ghost">üö™ Logout</button>
</div>
<div id="overlay"></div>

<div class="container">

  <!-- AUTH area -->
  <div id="authCard" class="card">
    <div class="logo-top" style="text-align:center">
      <!-- EDITABLE: id=logo_image -->
      <img id="logoImg" src="https://raw.githubusercontent.com/rjpapad111983-svg/Rjpapad-/refs/heads/main/file_0000000040986208ae9fdd85a3a3cbc8.png" alt="Logo">
      <!-- /EDITABLE -->
    </div>

    <h2 id="authTitle">Register / Login</h2>

    <div id="fullRegisterBlock" class="hidden">
      <label>‡§®‡§æ‡§Æ (optional)</label>
      <input id="reg_name" placeholder="Name (optional)" />
      <div style="height:8px"></div>

      <label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (required)</label>
      <input id="reg_mobile" placeholder="Mobile number" />
      <div style="height:8px"></div>

      <label>Parent / Joined by (optional)</label>
      <input id="reg_parent" placeholder="Parent mobile (optional)" />
      <div style="height:10px"></div>

      <div style="display:flex;gap:8px">
        <button id="registerBtn" class="primary" style="flex:1">Register</button>
        <button id="registerCancelBtn" class="ghost" style="flex:1">Cancel</button>
      </div>
    </div>

    <div id="loginOnlyBlock" class="hidden">
      <label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (Login)</label>
      <input id="login_mobile" placeholder="Enter mobile to login" />
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button id="loginOnlyBtn" class="primary" style="flex:1">Login</button>
        <button id="showRegisterForJoinBtn" class="ghost" style="flex:1">Register with Parent</button>
      </div>
    </div>

    <div id="authMsg" class="small" style="margin-top:8px;color:#b00"></div>
  </div>

  <!-- HOME -->
  <div id="homeArea" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="langbar">
        <button id="hi" class="langBtn">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
        <button id="en" class="langBtn">English</button>
        <button id="gu" class="langBtn">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</button>
      </div>
      <div class="note">Edit Mode: <span id="editModeLabel">OFF</span></div>
    </div>

    <!-- Banners (editable) -->
    <div style="margin-top:12px">
      <!-- EDITABLE: id=banner_primary -->
      <div id="bannerPrimary" class="banner">
        <img id="bannerImg" src="https://raw.githubusercontent.com/rjpapad111983-svg/Rjpapad-/refs/heads/main/file_00000000de7861faafb1b8052e9bd122%20(1).png" alt="Primary banner">
      </div>
      <!-- /EDITABLE -->
    </div>

    <div style="margin-top:12px">
      <!-- EDITABLE: id=banner_secondary -->
      <div id="bannerSecondary" class="banner">
        <img id="bannerImg2" src="https://raw.githubusercontent.com/rjpapad111983-svg/Rjpapad-/refs/heads/main/file_00000000aac061fdacd52dbbf8a83410.png" alt="Secondary banner">
      </div>
      <!-- /EDITABLE -->
    </div>

    <!-- EDITABLE: id=home_text -->
    <h3 id="homeTitle">RJ ‡§™‡§æ‡§™‡§°‡§º ‚Äî Welcome</h3>
    <p id="homeSubtitle" class="small">Use menu to open Wallet / My Team / MLM Tree.</p>
    <!-- /EDITABLE -->
  </div>

  <!-- Wallet -->
  <div id="walletArea" class="card hidden">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <h3 id="walletTitle">My Wallet</h3>
        <div style="font-size:20px;font-weight:700">‚Çπ<span id="bal">0</span></div>
      </div>

      <!-- SECTION: bank details editable only in wallet -->
      <div id="walletEditTools" class="edit-tools"></div>
    </div>

    <div style="height:12px"></div>

    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="addAmt" placeholder="Amount ‚Çπ" />
      <button id="addBtn" class="primary">Add (demo)</button>
    </div>

    <div style="margin-top:12px;padding:10px;border-radius:8px;border:1px solid #eee;background:#fafafa">
      <h4>Transfer to another customer</h4>
      <input id="t_mobile" placeholder="Recipient mobile number" style="margin-bottom:8px;width:100%"/>
      <input id="t_amount" placeholder="Amount ‚Çπ" style="margin-bottom:8px;width:100%"/>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="transferBtn" class="primary" style="flex:1">Transfer</button>
        <button id="transferCancelBtn" class="ghost" style="flex:1">Clear</button>
      </div>
      <div id="transferMsg" class="small" style="margin-top:8px"></div>
    </div>

    <div style="height:12px"></div>

    <div>
      <button id="withdrawBtn" class="ghost">Withdraw (Request)</button>
      <div id="withdrawNote" class="small" style="margin-top:8px;color:#333">
        Withdrawals: 1st day of month after 20:00 ‚Äî 10% fee ‚Äî Admin approval required.
      </div>
      <div id="walletMsg" class="small" style="margin-top:8px;color:#b00"></div>
    </div>

    <hr style="margin:12px 0">

    <!-- EDITABLE: id=downline_table -->
    <h4>Direct Team / Joined Customers (Bank details)</h4>
    <div id="downlineWrap" style="max-height:300px;overflow:auto;margin-top:8px">
      <table id="downlineTable" class="table" style="width:100%;display:none">
        <thead><tr><th>‡§®‡§æ‡§Æ</th><th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th><th>Bank</th><th>Account</th><th>IFSC</th><th>UPI</th></tr></thead>
        <tbody id="downlineBody"></tbody>
      </table>
      <div id="noDownlineMsg" class="small">No direct members yet.</div>
    </div>
    <!-- /EDITABLE -->
  </div>

  <!-- Team -->
  <div id="teamArea" class="card hidden">
    <h3>My Team</h3>
    <div id="teamList"></div>
    <div class="small" style="margin-top:8px">Click [+] on a slot to open join/register with parent prefilled.</div>
  </div>

  <!-- Tree -->
  <div id="treeArea" class="card hidden">
    <h3>MLM Tree</h3>
    <div id="treeView"></div>
  </div>

  <!-- Admin panel (internal) -->
  <div id="adminPanel" class="card hidden">
    <h3>Admin ‚Äî Edit & Lock</h3>
    <div class="note">‡§Ü‡§™ Admin Login ‡§ï‡•á ‡§¨‡§æ‡§¶ Edit Mode ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ Edit Mode ‡§Æ‡•á‡§Ç ‡§ï‡•á‡§µ‡§≤ ‡§µ‡§ø‡§∂‡•á‡§∑ EDITABLE ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§π‡•Ä ‡§∏‡§Ç‡§™‡§æ‡§¶‡§® ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§π‡•ã‡§Ç‡§ó‡•á‡•§</div>
    <div style="margin-top:12px">
      <label>Locked Sections:</label>
      <div id="lockedList" class="small" style="margin-top:6px"></div>
    </div>
    <div style="margin-top:12px">
      <label>Edit Sections (admin controls):</label>
      <div id="editableList" style="margin-top:8px"></div>
    </div>
    <div style="margin-top:12px">
      <button id="exitAdmin" class="ghost">Close Admin Panel</button>
    </div>
  </div>

</div>

<script>
/* ========= CONFIG ========= */
const ADMIN_PWD = "Rjpapad@2025";

/* editable sections registry: id -> {type:'html'|'src', selector}
   type 'html' means innerHTML/textContent is editable
   type 'src' means we can edit img src only
*/
const EDITABLES = {
  "logo_image": {type:'src', selector:'#logoImg'},
  "banner_primary": {type:'src', selector:'#bannerImg'},
  "banner_secondary": {type:'src', selector:'#bannerImg2'},
  "home_text": {type:'html', selector:'#homeTitle,#homeSubtitle'},
  "downline_table": {type:'html', selector:'#downlineWrap'},
  // add more ids here later if you want to allow edits
};

const KEY_LOCKS = 'rp_locked_sections_v1';
const KEY_APPDATA = 'rp_app_vars_v1'; // to store editable content edits (so edits persist in localStorage)
const KEY_USERS = 'rp_users_v6', KEY_ME='rp_me_v6', KEY_WDS='rp_withdraws_v6', KEY_LANG='rp_lang_v6';

function loadJson(key, def){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; } }
function saveJson(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }

/* app state */
let lockedSections = loadJson(KEY_LOCKS, []); // array of section ids
let appData = loadJson(KEY_APPDATA, {}); // store edited values for 'src' and 'html'
let users = loadJson(KEY_USERS, {}) || {};
let me = loadJson(KEY_ME, null);
let withdraws = loadJson(KEY_WDS, []) || [];
let lang = localStorage.getItem(KEY_LANG) || 'hi';

/* edit mode & admin state */
let isAdmin = false;
let editMode = false;

/* UI refs */
const menuToggle = document.getElementById('menuToggle'), drawer = document.getElementById('drawer'), overlay = document.getElementById('overlay');
menuToggle.onclick = ()=>{ drawer.classList.toggle('open'); overlay.style.display = drawer.classList.contains('open') ? 'block' : 'none'; };
overlay.onclick = ()=>{ drawer.classList.remove('open'); overlay.style.display='none'; };

const adminLoginBtn = document.getElementById('adminLoginBtn'), adminLogoutBtn = document.getElementById('adminLogoutBtn'), toggleEditModeBtn = document.getElementById('toggleEditMode');
const adminStatus = document.getElementById('adminStatus');
const editModeLabel = document.getElementById('editModeLabel');

const authCard=document.getElementById('authCard'), authTitle=document.getElementById('authTitle'), authMsg=document.getElementById('authMsg');
const fullRegister=document.getElementById('fullRegisterBlock'), loginOnly=document.getElementById('loginOnlyBlock');
const regName=document.getElementById('reg_name'), regMobile=document.getElementById('reg_mobile'), regParent=document.getElementById('reg_parent');
const registerBtn=document.getElementById('registerBtn'), registerCancelBtn=document.getElementById('registerCancelBtn');
const loginOnlyBtn=document.getElementById('loginOnlyBtn'), loginMobile=document.getElementById('login_mobile'), showRegisterForJoinBtn=document.getElementById('showRegisterForJoinBtn');

const homeArea=document.getElementById('homeArea'), bannerImg=document.getElementById('bannerImg'), bannerImg2=document.getElementById('bannerImg2'), homeTitle=document.getElementById('homeTitle'), homeSubtitle=document.getElementById('homeSubtitle');
const walletArea=document.getElementById('walletArea'), balSpan=document.getElementById('bal'), addAmt=document.getElementById('addAmt'), addBtn=document.getElementById('addBtn');
const withdrawBtn=document.getElementById('withdrawBtn'), walletMsg=document.getElementById('walletMsg');
const t_mobile=document.getElementById('t_mobile'), t_amount=document.getElementById('t_amount'), transferBtn=document.getElementById('transferBtn'), transferMsg=document.getElementById('transferMsg');

const teamArea=document.getElementById('teamArea'), teamList=document.getElementById('teamList');
const treeArea=document.getElementById('treeArea'), treeView=document.getElementById('treeView');
const adminPanel = document.getElementById('adminPanel'), btnAdminPanel=document.getElementById('btnAdminPanel');
const lockedListDiv = document.getElementById('lockedList'), editableListDiv = document.getElementById('editableList');
const walletEditTools = document.getElementById('walletEditTools');

/* helper: persist common data (locks & appData & users etc) */
function persistAll(){
  saveJson(KEY_LOCKS, lockedSections);
  saveJson(KEY_APPDATA, appData);
  saveJson(KEY_USERS, users);
  saveJson(KEY_ME, me);
  saveJson(KEY_WDS, withdraws);
  localStorage.setItem(KEY_LANG, lang);
}
setInterval(persistAll,2000);
window.addEventListener('beforeunload', persistAll);

/* ---------- Admin login/logout & edit mode ---------- */
adminLoginBtn.onclick = ()=>{
  const p = prompt('Enter admin password:');
  if(!p) return;
  if(p === ADMIN_PWD){
    isAdmin = true;
    adminStatus.innerText = 'Admin';
    adminLoginBtn.classList.add('hidden');
    adminLogoutBtn.classList.remove('hidden');
    toggleEditModeBtn.classList.remove('hidden');
    alert('Admin login successful');
  } else alert('Wrong password');
};

adminLogoutBtn.onclick = ()=>{
  isAdmin = false;
  editMode = false;
  adminStatus.innerText = 'User';
  adminLoginBtn.classList.remove('hidden');
  adminLogoutBtn.classList.add('hidden');
  toggleEditModeBtn.classList.add('hidden');
  toggleEditModeBtn.innerText = 'Enter Edit Mode';
  editModeLabel.innerText = 'OFF';
  disableAllEditUI();
};

/* toggle edit mode (admin only) */
toggleEditModeBtn.onclick = ()=>{
  if(!isAdmin) return alert('Admin login required');
  editMode = !editMode;
  editModeLabel.innerText = editMode ? 'ON' : 'OFF';
  toggleEditModeBtn.innerText = editMode ? 'Exit Edit Mode' : 'Enter Edit Mode';
  if(editMode) enableAllEditUI(); else disableAllEditUI();
};

/* show admin panel */
btnAdminPanel.onclick = ()=>{
  if(!isAdmin) return alert('Admin only');
  // fill locked list & editable list
  populateLockedList();
  populateEditableList();
  adminPanel.classList.remove('hidden');
  openSection('admin'); // open admin area
};
document.getElementById('exitAdmin').onclick = ()=>{
  adminPanel.classList.add('hidden');
  openSection('home');
};

/* ---------- Edit UI helpers ---------- */

function isLocked(id){
  return lockedSections.indexOf(id) !== -1;
}

/* enable little edit buttons next to each editable selector */
function enableAllEditUI(){
  // for each EDITABLES entry, if not locked add the tiny edit icon overlay
  Object.keys(EDITABLES).forEach(id=>{
    const meta = EDITABLES[id];
    if(isLocked(id)) return; // locked, no edit UI
    const existing = document.querySelector(`[data-edit-id="${id}"]`);
    if(existing) return;
    // create edit control
    const btn = document.createElement('button');
    btn.className = 'edit-btn';
    btn.dataset.editId = id;
    btn.title = 'Edit section (admin)';
    btn.innerText = '‚úé Edit';
    btn.onclick = ()=> openEditorFor(id);
    // attach near element (try parent)
    const el = document.querySelector(meta.selector);
    if(!el) return;
    el.parentElement.insertBefore(btn, el.nextSibling);
  });
  // show per-wallet edit field for bank (we keep it in admin mode)
  renderWalletEditTools();
}

/* remove edit buttons */
function disableAllEditUI(){
  document.querySelectorAll('[data-edit-id]').forEach(n=>n.remove());
  walletEditTools.innerHTML = '';
}

/* open editor modal (simple prompt-based or contentEditable in-place) */
function openEditorFor(id){
  if(!isAdmin || !editMode) return alert('Enable Edit Mode as admin first');
  if(isLocked(id)) return alert('This section is locked and cannot be edited');
  const meta = EDITABLES[id];
  if(!meta) return alert('No editable meta found');
  // If type src -> ask for new image URL
  if(meta.type === 'src'){
    const el = document.querySelector(meta.selector);
    const cur = el ? el.src || el.getAttribute('src') || '' : '';
    const v = prompt('Enter image URL for ' + id, appData[id] ? appData[id] : cur);
    if(v !== null){
      // set and save
      if(el){
        el.src = v;
        appData[id] = v;
        persistAll();
        alert('Saved to section: ' + id + '. If finished, you may lock the section from Admin Panel.');
      }
    }
    return;
  }
  // If html -> allow editing via a simple inline editor
  if(meta.type === 'html'){
    // open simple inline editor: turn selector elements into contentEditable
    const nodes = document.querySelectorAll(meta.selector);
    if(!nodes.length) return alert('Editable node not found');
    nodes.forEach(n=>{
      n.classList.add('editable-highlight');
      n.contentEditable = true;
    });
    // show Save / Cancel controls
    const ctrl = document.createElement('div');
    ctrl.style.marginTop = '8px';
    const saveBtn = document.createElement('button'); saveBtn.className='primary'; saveBtn.innerText='Save'; 
    const cancelBtn = document.createElement('button'); cancelBtn.className='ghost'; cancelBtn.innerText='Cancel';
    ctrl.appendChild(saveBtn); ctrl.appendChild(cancelBtn);
    nodes[nodes.length-1].parentElement.appendChild(ctrl);
    saveBtn.onclick = ()=>{
      // gather innerHTML of all nodes into a single HTML and store
      let combined = '';
      nodes.forEach(n=> combined += n.outerHTML );
      appData[id] = combined;
      // remove editing UI
      nodes.forEach(n=>{ n.classList.remove('editable-highlight'); n.contentEditable = false; });
      ctrl.remove();
      persistAll();
      alert('Saved section: ' + id + '. Lock it from Admin Panel if final.');
    };
    cancelBtn.onclick = ()=>{
      // revert contentEditable and restore previous appData if any
      nodes.forEach(n=>{
        n.classList.remove('editable-highlight'); n.contentEditable = false;
        // restore from appData if present
      });
      if(appData[id]){
        // replace nodes with appData HTML
        const div = document.createElement('div'); div.innerHTML = appData[id];
        // replace each selector node area with div children matched roughly
        // simple approach: replace parent innerHTML with saved snippet (safe because admin editing)
        nodes[0].parentElement.innerHTML = appData[id] + nodes[nodes.length-1].parentElement.innerHTML;
      }
      ctrl.remove();
    };
  }
}

/* Admin panel: list locked & editable sections with Lock/Unlock controls */
function populateLockedList(){
  lockedListDiv.innerHTML = '';
  if(!lockedSections.length) lockedListDiv.innerText = 'None';
  lockedSections.forEach(id=>{
    const d = document.createElement('div');
    d.innerHTML = `<b>${id}</b> <span class="locked-badge">LOCKED</span> <button class="ghost" data-unlock="${id}">Unlock</button>`;
    lockedListDiv.appendChild(d);
    d.querySelector('[data-unlock]').onclick = ()=>{
      if(!confirm('Unlock section ' + id + '?')) return;
      lockedSections = lockedSections.filter(x=>x!==id);
      persistAll();
      populateLockedList();
      alert('Unlocked: ' + id);
      // refresh UI enable
      if(isAdmin && editMode) enableAllEditUI();
    };
  });
}

/* show editable list with Lock controls */
function populateEditableList(){
  editableListDiv.innerHTML = '';
  Object.keys(EDITABLES).forEach(id=>{
    const locked = isLocked(id);
    const d = document.createElement('div');
    d.style.display='flex'; d.style.alignItems='center'; d.style.gap='8px'; d.style.marginTop='6px';
    d.innerHTML = `<div style="flex:1"><b>${id}</b> ‚Äî selector: ${EDITABLES[id].selector}</div>`;
    const editBtn = document.createElement('button'); editBtn.className='ghost'; editBtn.innerText='Open Editor';
    editBtn.onclick = ()=> openEditorFor(id);
    const lockBtn = document.createElement('button'); lockBtn.className='primary'; lockBtn.innerText = locked ? 'Locked' : 'Lock Section';
    if(locked) lockBtn.disabled = true;
    lockBtn.onclick = ()=>{
      if(!confirm('Lock section ' + id + ' ? Locked sections cannot be edited via UI until unlocked from Admin Panel.')) return;
      if(!lockedSections.includes(id)) lockedSections.push(id);
      persistAll();
      populateLockedList();
      populateEditableList();
      disableEditButtonFor(id);
      alert('Section locked: ' + id);
    };
    d.appendChild(editBtn); d.appendChild(lockBtn);
    editableListDiv.appendChild(d);
  });
}

/* disable single edit button (when locked) */
function disableEditButtonFor(id){
  const b = document.querySelector(`[data-edit-id="${id}"]`);
  if(b) b.remove();
}

/* render wallet edit tools (example to add bank editing in Wallet) */
function renderWalletEditTools(){
  walletEditTools.innerHTML = '';
  if(!isAdmin || !editMode) return;
  // Show small quick links to edit or lock the downline_table section etc
  const eIds = Object.keys(EDITABLES);
  eIds.forEach(id=>{
    if(isLocked(id)) return;
    const btn = document.createElement('button'); btn.className='edit-btn'; btn.innerText = `Edit ${id}`; btn.onclick = ()=> openEditorFor(id);
    walletEditTools.appendChild(btn);
  });
}

/* ---------- Load saved appData into DOM on init ---------- */
function applySavedAppData(){
  // for src items
  Object.keys(EDITABLES).forEach(id=>{
    const meta = EDITABLES[id];
    const saved = appData[id];
    if(!saved) return;
    if(meta.type === 'src'){
      const el = document.querySelector(meta.selector);
      if(el) el.src = saved;
    } else if(meta.type === 'html'){
      // saved contains outerHTML of nodes (we stored combined outerHTML earlier)
      // We'll replace parent element innerHTML partially: find first selector node's parent and replace if possible.
      const selector = meta.selector;
      // naive insert: replace first selector element with saved HTML
      const firstSel = document.querySelector(selector.split(',')[0]);
      if(firstSel && firstSel.parentElement){
        // append saved HTML at top of parent
        firstSel.parentElement.insertAdjacentHTML('afterbegin', saved);
        // remove original nodes (we will keep the saved copy)
        document.querySelectorAll(selector).forEach(n=>{
          if(n !== firstSel.parentElement.firstElementChild) n.remove();
        });
      }
    }
  });
}

/* ---------- BASIC APP BEHAVIOR (auth, pages, wallet, transfer, withdraw, team, tree) ---------- */
/* reuse keys and functions from previous versions ‚Äî simplified for brevity */

function loadData(){
  users = loadJson(KEY_USERS, {});
  me = loadJson(KEY_ME, null);
  withdraws = loadJson(KEY_WDS, []);
}
loadData();

/* UI controls for showing auth / pages */
function showAuthBasedOnUsers(){
  authMsg.innerText = '';
  if(Object.keys(users).length === 0){
    fullRegister.classList.remove('hidden'); loginOnly.classList.add('hidden'); authTitle.innerText = 'Register (first user)';
  } else {
    fullRegister.classList.add('hidden'); loginOnly.classList.remove('hidden'); authTitle.innerText = 'Login';
  }
  if(me){
    enterApp();
  } else {
    authCard.classList.remove('hidden');
    openSection('home');
  }
}

/* Register */
registerBtn.onclick = ()=>{
  const n = regName.value.trim(), m = regMobile.value.trim(), p = regParent.value.trim();
  if(!m){ authMsg.innerText = '‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à'; return; }
  if(users[m]){ authMsg.innerText = 'User already exists ‚Äî please login'; return; }
  users[m] = { mobile: m, name: n || m, balance: 0, parent: null, children: [], bank: null };
  if(p && users[p]){ users[m].parent = p; users[p].children = users[p].children || []; users[p].children.push(m); }
  me = { mobile: m, name: users[m].name };
  persistAll();
  enterApp();
};
registerCancelBtn.onclick = ()=>{ regName.value=''; regMobile.value=''; regParent.value=''; showAuthBasedOnUsers(); };

/* Login */
loginOnlyBtn.onclick = ()=>{ const m = loginMobile.value.trim(); if(!m) return authMsg.innerText='‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§°‡§æ‡§≤‡•á‡§Ç'; if(users[m]){ me = { mobile:m, name:users[m].name }; persistAll(); enterApp(); } else authMsg.innerText='User ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ'; };
showRegisterForJoinBtn.onclick = ()=>{ fullRegister.classList.remove('hidden'); loginOnly.classList.add('hidden'); authTitle.innerText='Register with Parent'; };

/* pages */
function hideAll(){ document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden')); adminPanel.classList.add('hidden'); authCard.classList.add('hidden'); }
function openSection(name){
  hideAll();
  // show specific sections by id
  if(name==='home') homeArea.classList.remove('hidden');
  if(name==='wallet') walletArea.classList.remove('hidden');
  if(name==='team') teamArea.classList.remove('hidden');
  if(name==='tree') treeArea.classList.remove('hidden');
  if(name==='admin') adminPanel.classList.remove('hidden');
}
function enterApp(){ authCard.classList.add('hidden'); updateLoggedAs(); setLang(lang); openSection('wallet'); updateWallet(); renderDownline(); }

/* menu buttons */
document.getElementById('btnWallet').onclick = ()=>{ closeDrawer(); openSection('wallet'); updateWallet(); renderDownline(); };
document.getElementById('btnMyTeam').onclick = ()=>{ closeDrawer(); openSection('team'); renderTeam(); };
document.getElementById('btnTree').onclick = ()=>{ closeDrawer(); openSection('tree'); renderTree(); };
document.getElementById('btnOrder').onclick = ()=>{ closeDrawer(); simulateOrder(); };
document.getElementById('btnLogout').onclick = ()=>{ me=null; saveJson(KEY_ME,null); location.reload(); };

/* language */
function setLang(l){ lang = l; localStorage.setItem(KEY_LANG,l); persistAll(); }
document.querySelectorAll('.langBtn').forEach(b=>b.addEventListener('click', ()=> setLang(b.id)));

/* wallet funcs */
function updateWallet(){ if(!me) return; balSpan.innerText = (users[me.mobile].balance||0).toFixed(2); updateLoggedAs(); }
addBtn.onclick = ()=>{ if(!me) return alert('Login first'); const v = parseFloat(addAmt.value||0); if(!v||v<=0) return alert('Invalid'); users[me.mobile].balance = Math.round(((users[me.mobile].balance||0)+v)*100)/100; addAmt.value=''; persistAll(); updateWallet(); };

transferBtn.onclick = ()=>{
  if(!me) return alert('Login first');
  const to = (t_mobile.value||'').trim();
  const amt = parseFloat(t_amount.value||0);
  transferMsg.innerText=''; transferMsg.style.color='';
  if(!to) return transferMsg.innerText='Recipient mobile ‡§ö‡§æ‡§π‡§ø‡§è';
  if(!amt || amt <= 0) return transferMsg.innerText='Valid amount ‡§°‡§æ‡§≤‡•á‡§Ç';
  if(!users[to]) return transferMsg.innerText='Recipient user not found';
  if((users[me.mobile].balance||0) < amt) return transferMsg.innerText='‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§®‡§π‡•Ä‡§Ç';
  users[me.mobile].balance = Math.round(((users[me.mobile].balance||0)-amt)*100)/100;
  users[to].balance = Math.round(((users[to].balance||0)+amt)*100)/100;
  persistAll(); updateWallet();
  transferMsg.style.color='green'; transferMsg.innerText = `‚Çπ${amt} ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ${to} ‡§ï‡•ã ‡§≠‡•á‡§ú ‡§¶‡§ø‡§è ‡§ó‡§è‡•§`;
  setTimeout(()=>{ t_mobile.value=''; t_amount.value=''; transferMsg.innerText=''; transferMsg.style.color=''; },1500);
};

function canRequestWithdraw(){
  const now = new Date(); return (now.getDate()===1 && now.getHours()>=20);
}
withdrawBtn.onclick = ()=>{
  if(!me) return alert('Login first');
  const u = users[me.mobile];
  if(!u || (u.balance||0) <= 0) return alert('No balance');
  if(!u.bank||!u.bank.name||!u.bank.account||!u.bank.ifsc) return alert('Withdraw ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡•à‡§Ç‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä Wallet ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (Admin Edit Mode ‡§∏‡•á enable ‡§ï‡§∞‡•á‡§Ç)‡•§');
  if(!canRequestWithdraw()){ walletMsg.style.color='#b00'; walletMsg.innerText = `Withdraw ‡§ï‡•á‡§µ‡§≤ ‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä 1 ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§∞‡§æ‡§§ 8 ‡§¨‡§ú‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∏‡§Ç‡§≠‡§µ‡•§`; return; }
  const want = parseFloat(prompt('Enter withdraw amount (‚Çπ)')); if(!want||want<=0) return; if(want > u.balance) return alert('Not enough');
  const fee = Math.round(want*0.10); const net = want - fee;
  u.balance = Math.round((u.balance - want)*100)/100;
  withdraws.push({id:Date.now(), mobile:me.mobile, amount:want, fee, net, status:'pending', ts:new Date().toISOString(), bank: u.bank});
  persistAll(); updateWallet(); walletMsg.style.color='green'; walletMsg.innerText = `Withdraw request submitted ‚Çπ${want}.`;
};

/* team & tree */
function renderTeam(){ teamList.innerHTML=''; if(!me) return; const kids = users[me.mobile].children||[]; if(!kids.length){ teamList.innerHTML = '<div class="small">No members</div>'; return; } kids.forEach(m=>{ const d=document.createElement('div'); d.className='card'; d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center'; d.style.marginBottom='6px'; d.innerHTML = `<div>${users[m].name||m} <div class="small">${m}</div></div><div><button class="ghost">[+]</button></div>`; teamList.appendChild(d); d.querySelector('button').onclick = ()=> alert('Downline: ' + ((users[m].children||[]).map(x=>users[x].name||x).join(', ') || 'None')); }); }
function renderTree(){ treeView.innerHTML=''; if(!me) return; const root = users[me.mobile]; const box = document.createElement('div'); box.className='card'; box.innerHTML = `<b>${root.name}</b><div class="small">${root.mobile}</div>`; treeView.appendChild(box); const kids = root.children||[]; if(!kids.length){ const e=document.createElement('div'); e.className='card'; e.style.textAlign='center'; e.innerHTML='No downline<br/><button class="primary" id="joinHere">Join here</button>'; treeView.appendChild(e); e.querySelector('#joinHere').onclick = ()=> { fullRegister.classList.remove('hidden'); loginOnly.classList.add('hidden'); regParent.value = me.mobile; authTitle.innerText = 'Register under '+me.mobile; authCard.classList.remove('hidden'); }; return; } const row=document.createElement('div'); row.style.display='flex'; row.style.gap='12px'; row.style.marginTop='12px'; kids.forEach(k=>{ const c=document.createElement('div'); c.className='card'; c.style.minWidth='140px'; c.style.textAlign='center'; c.innerHTML = `${users[k].name || k}`; row.appendChild(c); }); treeView.appendChild(row); }

/* simulate order to credit sponsor */
function simulateOrder(){ if(!me) return alert('Login first'); const sponsor = users[me.mobile].parent; if(sponsor && users[sponsor]){ users[sponsor].balance = Math.round(((users[sponsor].balance||0)+50)*100)/100; persistAll(); alert('‚Çπ50 commission credited to sponsor'); } else alert('No sponsor'); }

/* admin panel: lock/unlock handled earlier in populate lists */

/* render downline table */
function renderDownline(){
  const downlineBody = document.getElementById('downlineBody');
  const downlineTable = document.getElementById('downlineTable');
  const noDownlineMsg = document.getElementById('noDownlineMsg');
  downlineBody.innerHTML = '';
  if(!me) return;
  const kids = users[me.mobile].children||[];
  if(!kids.length){ downlineTable.style.display='none'; noDownlineMsg.style.display='block'; return; }
  downlineTable.style.display='table'; noDownlineMsg.style.display='none';
  kids.forEach(m=>{
    const u = users[m];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.name||''}</td><td>${u.mobile||''}</td><td>${u.bank?.name||''}</td><td>${u.bank?.account||''}</td><td>${u.bank?.ifsc||''}</td><td>${u.bank?.upi||''}</td>`;
    downlineBody.appendChild(tr);
  });
}

/* logged as */
function updateLoggedAs(){ document.getElementById('loggedAs').innerText = me ? `Logged as: ${users[me.mobile]?.name || me.mobile}` : 'Not logged'; }

/* disable drawer on close */
function closeDrawer(){ drawer.classList.remove('open'); overlay.style.display='none'; }

/* apply saved editable appData on load */
applySavedAppData();

/* enable edit UI if already admin+editMode on reload (unlikely) */
if(isAdmin && editMode) enableAllEditUI();

/* initialize show */
updateLoggedAs();
showAuthBasedOnUsers();
setLang(lang);
persistAll();

/* expose a simple way to add bank details via Admin Edit Mode:
   Admin can open editor for 'downline_table' or custom flows,
   but to allow adding bank info for current user via UI we provide quick function if admin+editMode:
*/
function addBankForCurrentUser(bankObj){
  if(!me) return alert('No user logged in');
  users[me.mobile].bank = bankObj;
  persistAll();
  updateWallet();
  alert('Bank saved for user: ' + me.mobile);
}

/* small helper: build editable list on initial load for admin panel if admin opens later */
function initAdminUIIfNeeded(){
  // no-op here, populate functions will run when admin opens panel
}

/* allow saving image src via keyboard pasting into bookmarklet-like prompt */
document.addEventListener('keydown', function(e){
  // Admin quick-save: Ctrl+Shift+S opens prompt to set appData for a given editable id (only if admin+editMode)
  if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='s'){
    if(!isAdmin || !editMode) return alert('Admin+EditMode required');
    const id = prompt('Enter editable id (e.g. banner_primary):');
    if(!id || !EDITABLES[id]) return alert('Invalid id');
    openEditorFor(id);
  }
});

/* make sure locked edits remove edit buttons on init */
Object.keys(EDITABLES).forEach(id=>{ if(isLocked(id)) disableEditButtonFor(id); });

</script>
</body>
</html>
